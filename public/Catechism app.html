<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catechumen</title>
    <style>
        /* --- Existing Catechism App Styles --- */
        body {
            font-family: 'Georgia', serif;
            text-shadow: 1px 1px 4px #000;
            background-color: #3a6646;
            background-image: radial-gradient(50% 104%, #457654 46%, #21412A 100%);
            color: white;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
            min-height: 100vh; /* Ensure body takes full viewport height */
            display: flex;
            flex-direction: column;
            pointer-events: auto;
            overflow-x: hidden; /* Prevent horizontal scroll during animation */
        }

        header {
            text-align: center;
            background-color: #9C8547; /* Navy blue for Catholic theme */
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        header h1 {
            margin: 0;
            font-size: 2em;
        }
        
        nav {
            display: flex;
            justify-content: center;
            flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
            margin-bottom: 20px;
        }
        button {
            background-color: #7b6b30;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 1em;
            /* Enhanced Button Hover Effect */
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        button:hover {
            background-color: #5f5429;
            transform: translateY(-2px); /* Subtle lift effect */
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.2);
        }
        /* Main content sections container */
        .main-content-container {
  display: fadeIn .5s;
  opacity: 0;
  transition: opacity 0s ease-out;
}
        /* --- Main Content Container --- */
.main-content-container {
  position: relative; /* For positioning internal sections */
  flex-grow: 1;
  width: 100%;
  max-width: 900px;
  margin: 0 auto;
  display: none;         /* Hidden by default */
  opacity: 0;            /* Invisible initially */
  justify-content: center;
  align-items: flex-start;
  transition: opacity 1s ease-in-out;
}

/* This class will be added by JS after splash screen */
.main-content-container.visible {
  display: flex;
  opacity: 1;
}

        section {
            background: #9C8547;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            /* Smooth Section Transitions */
            opacity: 1;
            visibility: visible; /* Default visible */
            transition: opacity 1s ease-in-out;
            position: absolute; /* Keep absolute for transitions, but manage parent */
            width: 100%; /* Take full width of its relative parent */
            top: 0; /* Align to top of parent */
            left: 0; /* Align to left of parent */
            box-sizing: border-box; /* Include padding in width */
        }
        /* The .hidden class is crucial for hiding sections with transitions */
        section.hidden {
            opacity: 0;
            visibility: hidden; /* Hide element visually and from screen readers */
            pointer-events: none; /* Disable interactions when hidden */
        }
        ul {
            list-style-type: none;
            padding: 0;
        }
        li {
            margin: 10px 0;
        }
        .quiz-question {
            margin-bottom: 20px;
        }
        .quiz-option {
            display: block;
            margin: 5px 0;
        }
        pre {
            white-space: pre-wrap;
            font-family: inherit;
        }
        .lesson-content {
            margin-bottom: 20px;
        }
        .video-placeholder {
            background-color: transparent;
            padding: 0;
            margin: 0;
            border: none;
            text-align: center;
            overflow: hidden;
        }

        /* --- Custom Alert Modal Styles --- */
        #custom-alert-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #ffffff;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            z-index: 10000; /* EXTREMELY HIGH */
            max-width: 350px;
            text-align: center;
            color: #333;
            animation: fadeIn 0.3s ease-out;
            pointer-events: auto;
        }
        #custom-alert-modal .alert-message {
            margin-bottom: 20px;
            font-size: 1.1em;
            font-weight: 500;
        }
        #custom-alert-modal .alert-ok-button {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }
        #custom-alert-modal .alert-ok-button:hover {
            background-color: #5f5429;
        }
        /* Animation for custom alert */
        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, -60%); }
            to { opacity: 1; transform: translate(-50%, -50%); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translate(-50%, -50%); }
            to { opacity: 0; transform: translate(-50%, -60%); }
        }
        .fade-out {
            animation: fadeOut 0.3s ease-out forwards;
        }

        /* Rule to hide the custom alert modal when it has the 'hidden' class */
        #custom-alert-modal.hidden {
            display: none;
        }

        /* Alert Overlay for Custom Alert */
        #alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* Slightly darker for alerts */
            z-index: 9999; /* Just below the custom alert */
            display: none; /* Hidden by default */
            pointer-events: auto;
        }
        #alert-overlay.active {
            display: block;
        }

        /* --- Integrated Chat Section Styles --- */
        #chat-section { /* Renamed from #chat-modal */
            width: 100%; /* Take full width of its parent .main-content-container */
            max-width: 900px; /* Match other sections */
            margin: 0 auto; /* Center it */
            height: auto; /* Allow height to adjust to content */
            min-height: 400px; /* Ensure some minimum height */
            background-color: #f0f0f0; /* Light background for the chat box */
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 1; /* Normal stacking context within main-content-container */
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Hide scrollbars if content overflows */
            padding: 20px; /* Inner padding */
            box-sizing: border-box; /* Include padding in width/height */
            color: #333; /* Dark text for readability on light background */
        }

        /* --- Chat Widget Inner Styles (adapted from your provided snippet) --- */
        #chat-section .chat-container { /* Target chat-container inside chat-section */
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 100%; /* Take full width of section */
            height: 100%; /* Take full height of section */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }
        #chat-section .chat-header { /* This was .p-4.bg-blue-600 in your snippet, adapted to a class */
            background-color: #3a6646; /* Green for chat header */
            color: white;
            text-align: center;
            font-size: 1.5em; /* Adjusted font size */
            font-weight: bold;
            padding: 1rem;
            border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
        }
        
        #chat-section {
  			text-shadow: none;
		}
        #chat-section .messages-area {
            flex-grow: 1;
            padding: 1.5rem;
            overflow-y: auto;
            max-height: none; /* Allow messages area to fill available space in section */
            min-height: 10rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            background-color: #f9fafb;
            border-bottom: 1px solid #e0e0e0;
        }
        #chat-section .message-bubble {
            max-width: 85%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            word-wrap: break-word;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        #chat-section .message-bubble.sent {
            background-color: #dbeafe;
            align-self: flex-end;
            color: #1e40af;
        }
        #chat-section .message-bubble.received {
            background-color: #f3f4f6;
            align-self: flex-start;
            color: #374151;
        }
        #chat-section .message-sender {
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: #6b7280;
        }
        #chat-section .input-area {
            padding: 1.5rem;
            display: flex;
            gap: 0.75rem;
            background-color: #ffffff;
            border-bottom-left-radius: 0.75rem; /* Match section border radius */
            border-bottom-right-radius: 0.75rem; /* Match section border radius */
        }
        #chat-section .input-area input {
            flex-grow: 1;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.75rem;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s;
        }
        #chat-section .input-area input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }
        #chat-section .input-area button {
            background-color: #9C8547; /* Blue button */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        #chat-section .input-area button:hover {
            background-color: #5f5429;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        #chat-section .loading-message {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }
        #close-chat-button { /* Still needed if you want a close button within the integrated chat */
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #dc3545; /* Red for close button */
            color: white;
            border: none;
            border-radius: 50%; /* Make it round */
            width: 30px;
            height: 30px;
            font-size: 1em;
            line-height: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        #close-chat-button:hover {
            background-color: #5f5429;
        }

        /* --- Username/Class Input Specific Styles --- */
        #chat-section .user-status-area {
            padding: 10px 15px;
            background-color: #e2e8f0; /* Light gray-blue */
            border-bottom: 1px solid #cbd5e0;
            text-align: center;
            font-size: 0.9em;
            color: #4a5568;
        }
        #chat-section #username-class-input-area { /* New ID for combined input area */
            display: flex;
            flex-direction: column; /* Stack inputs vertically */
            gap: 10px;
            justify-content: center;
            align-items: center;
            margin-top: 10px;
        }
        #chat-section #username-input,
        #chat-section #class-input { /* Apply styles to both inputs */
            padding: 8px 12px;
            border: 1px solid #a0aec0;
            border-radius: 5px;
            flex-grow: 1;
            width: 80%; /* Make them take more width */
            max-width: 250px; /* Limit input width */
        }
        #chat-section #save-profile-button { /* Renamed button */
            background-color: #9C8547; /* Green for save */
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
        #chat-section #save-profile-button:hover {
            background-color: #5f5429;
        }

        /* --- Rosary Section Specific Styles --- */
        #rosary-section {
            background: #D4AF37; /* Gold/Brass color for rosary section */
            color: #333;
            text-align: center;
            padding: 30px;
            min-height: 300px; /* Ensure enough height for content */
            justify-content: flex-start; /* Align content to top within flex container */
        }
        #rosary-section h2 {
            font-size: 2.2em;
            margin-bottom: 20px;
            color: #6A0505; /* Deep red for titles */
        }
        #rosary-controls {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }
        #rosary-controls button {
            background-color: #8B4513; /* SaddleBrown for rosary buttons */
            color: white;
            padding: 12px 25px;
            font-size: 1.1em;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        #rosary-controls button:hover {
            background-color: #5f5429; /* Darker brown on hover */
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        #rosary-display {
            margin-top: 30px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 25px;
            border-radius: 10px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
            color: #333;
            text-align: left;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        #rosary-display h3 {
            font-size: 1.8em;
            color: #6A0505;
            margin-bottom: 15px;
            text-align: center;
        }
        #rosary-display p {
            font-size: 1.1em;
            line-height: 1.8;
            margin-bottom: 10px;
            text-align: center;
        }
        #rosary-display .scripture {
            font-style: italic;
            color: #555;
            margin-top: 15px;
            white-space: pre-wrap; /* Preserve line breaks in scripture */
        }
        #rosary-display .rosary-current-prayer {
            font-weight: bold;
            color: #21412A;
        }

  /* --- Splash Screen Styles --- */
  #splash-screen {
  position: fixed;
  inset: 0;
  width: 100%;
  height: 100%;
  background-color: #21412A;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  opacity: 0; /* Start transparent */
  animation: splashFadeIn 1s ease-out forwards;
  pointer-events: auto;
  transition: opacity 1s ease-out;
}

  #splash-screen.fade-out {
    opacity: 0;
    pointer-events: none;
  }

      /* --- Splash Screen Styles --- */
        #splash-screen {
            position: fixed;
            inset: 0;
            width: 100%;
            height: 100%;
            background-color: #21412A;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 1s ease-out;
            pointer-events: auto;
        }

        #splash-screen.fade-out {
            opacity: 0;
            pointer-events: none; /* Disable interactions after fade out starts */
        }

        #splash-title-banner {
            color: #ffffff;
            font-family: 'Georgia', serif;
            font-size: clamp(2rem, 5vw, 3rem);
            text-align: center;
            text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.8);
            letter-spacing: 2px;
            /* Combined animation for smoother flow */
            animation: bannerIntroAnimation 4s ease-in-out forwards; 
        }

        #splash-title-banner h1 {
            margin: 0;
            font-size: 1em; /* Relative to parent font-size */
            font-weight: 700;
            text-transform: uppercase;
        }

        /* New combined animation for the banner */
    @keyframes bannerIntroAnimation {
            0% {
                opacity: 0;
                transform: scale(0.1);
            }
           70% { /* Swell up to max, then immediately starts shrinking */
                opacity: 1;
                transform: scale(2.2);
            }
            100% { /* Shrink and fade out */
                opacity: 0;
                transform: scale(0.1);
            }
        }
    </style>

<!-- Splash Screen HTML -->
<div id="splash-screen">
  <div id="splash-title-banner">
    <h1>CATECHUMEN</h1>
  </div>
</div>

<script>
  window.addEventListener('load', () => {
    const splashScreen = document.getElementById('splash-screen');
    const mainContent = document.querySelector('.main-content-container');

    // Hide main content immediately
    if (mainContent) {
      mainContent.style.display = 'none';
      mainContent.classList.remove('visible');
    }

    // Trigger fade-out after animation duration (7.5s)
    setTimeout(() => {
      splashScreen.classList.add('fade-out');

      // Wait for fade-out transition to finish (1s), then show main content
      setTimeout(() => {
        splashScreen.style.display = 'none';

        if (mainContent) {
          mainContent.style.display = 'flex'; // or 'block'
          requestAnimationFrame(() => {
            mainContent.classList.add('visible'); // triggers opacity transition
          });
        }
      }, 1000); // match CSS transition duration
    }, 4500); // match total splash animation time
  });
</script>

    <header>
        <h1>CATECHUMEN</h1>
    </header>
    <nav>
        <button id="lessons-nav-button">Lessons & Quizzes</button>
        <button id="spiritual-nav-button">Spiritual Formation</button>
        <button id="chat-menu-button">Chat</button> <!-- This button now shows the integrated chat section -->
        <button id="resources-nav-button">Student Resources</button>
        <button id="quit-nav-button">Quit</button>
    </nav>

  <!-- Main content container for sections -->
    <div class="main-content-container">
        <section id="lessons-section" class="hidden">
            <h2>Lessons</h2>
            <!-- Lesson content goes here -->
            <p>This section will contain progressive instruction and quizzes.</p>
            <div id="lesson-controls">
                <button id="lesson-start-button">Start Lessons</button>
            </div>
        </section>
        
        <section id="lessons" class="hidden">
        <h2>Lessons Available</h2>
        <ul id="lessons-list"></ul>
        <button onclick="showSection('main')">Back to Main Menu</button>
    </section>

    <section id="lesson-content" class="hidden">
        <h2 id="lesson-title"></h2>
        <div id="lesson-text" class="lesson-content"></div>
        <button onclick="startQuiz()">Start Quiz</button>
        <button onclick="showSection('lessons')">Back</button>
    </section>

    <section id="quiz" class="hidden">
        <h2>Quiz</h2>
        <div id="quiz-questions"></div>
        <button onclick="submitQuiz()">Submit</button>
        <button onclick="showSection('lesson-content')">Back</button>
    </section>
        

        <section id="spiritual-formation-section" class="hidden">
        <h2>Spiritual Formation</h2>
        <ul>
            <li><button onclick="showSection('daily')">Lectio Divina</button></li>
            <li><button onclick="showSection('rosary')">Guided Rosary</button></li>
            <li><button onclick="showSection('prayers')">Common Prayers</button></li>
            <li><button onclick="showSection('lotH')">Liturgy of the Hours</button></li>
        </ul>
        <button onclick="showSection('main')">Back to Main Menu</button>
    </section>

        <section id="rosary-section" class="hidden">
            <h2>The Holy Rosary</h2>
            <div id="rosary-display">
                <h3 id="current-mystery-title"></h3>
                <p id="current-prayer-text" class="rosary-current-prayer"></p>
                <p id="current-scripture" class="scripture"></p>
            </div>
            <div id="rosary-controls">
                <button id="rosary-start-button">Start Rosary</button>
                <button id="rosary-next-button" class="hidden">Next Prayer</button>
                <button id="rosary-reset-button" class="hidden">Reset Rosary</button>
                <button id="rosary-back-to-spiritual-button">Back to Spiritual Formation</button>
            </div>
        </section>
        
         <section id="student-resources-section" class="hidden">
        <h2>Student Resources</h2>
        <ul>
            <li><a href="https://usccb.cld.bz/Catechism-of-the-Catholic-Church/" target="_blank"><button>Catechism of the Catholic Church</button></a></li>
            <li><a href="https://bible.usccb.org/bible" target="_blank"><button>Holy Bible</button></a></li>
            <li><a href="https://www.catholic.com/" target="_blank"><button>Catholic Answers</button></a></li>
            <li><a href="https://catechisminayear.fireside.fm/" target="_blank"><button>Catechism in a Year with Fr. Mike Schmitz</button></a></li>
        </ul>
        <button onclick="showSection('main')">Back to Main Menu</button>
    </section>
    
    
    <section id="daily" class="hidden">
    <div class="video-placeholder">'<iframe width="560" height="315" src="https://www.youtube.com/embed/gKYEOc3ik9k?si=m74MuYyABkoXRgYt" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>'
    <p><strong>Consider reading and praying with one of the Church's daily readings.</strong><br>
        <div class="cg_mrc_widget"></div>
<script src="https://cdn1.catholicgallery.org/wp-content/uploads/widgets/rich-card/cg_mrc_widget.js" async></script>
<p><strong>Lectio (Read) Slowly and attentively.</strong><br>
<p><strong>Meditatio (Meditate) Reflect on words or a phrase.</strong><br>
<p><strong>Oratio (Pray) Talk and listen to God.</strong><br>
<p><strong>Contemplatio (Compemplate) Rest in God. Savor His love.</strong><br>
        <button onclick="showSection('spiritual')">Back</button>
    </section>
    
    <section id="spiritual" class="hidden">
        <h2>Spiritual Formation</h2>
        <ul>
            <li><button onclick="showSection('daily')">Lectio Divina</button></li>
            <li><button onclick="showSection('rosary')">Guided Rosary</button></li>
            <li><button onclick="showSection('prayers')">Common Prayers</button></li>
            <li><button onclick="showSection('lotH')">Liturgy of the Hours</button></li>
        </ul>
        <button onclick="showSection('main')">Back to Main Menu</button>
    </section>

    <section id="lotH" class="hidden">
        <h2>Liturgy of the Hours</h2>
        <p>The Liturgy of the Hours, also known as the Divine Office, is the official prayer of the Catholic Church that sanctifies the day through Psalms, Scripture readings, hymns, and intercessions. It is prayed at fixed times throughout the day, uniting the faithful in continuous praise and petition. Rooted in ancient tradition and emphasized in Vatican II's Sacrosanctum Concilium, it fosters a deeper communion with Christ and the Church. Use the widget below to access today's prayers in English.</p>
        <iframe src="https://www.ibreviary.com/m2/breviario.php?lang=en" width="340" height="500" style="border: 1px solid #151515;"></iframe>
        <button onclick="showSection('spiritual')">Back</button>
    </section>

    <section id="rosary" class="hidden">
        <h2>Guided Rosary</h2>
        <div class="video-placeholder">'<iframe width="560" height="315" src="https://www.youtube.com/embed/HXcWknfC0vI?si=TkBe-4NatYLTEmjw" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>'
        <p>Choose Mysteries:</p>
        <ul>
            <li><button onclick="startRosary('Joyful')">Joyful (Monday & Saturday)</button></li>
            <li><button onclick="startRosary('Sorrowful')">Sorrowful (Tuesday & Friday)</button></li>
            <li><button onclick="startRosary('Glorious')">Glorious (Wednesday & Sunday)</button></li>
            <li><button onclick="startRosary('Luminous')">Luminous (Thursday)</button></li>
        </ul>
        <div id="rosary-progress" class="hidden"></div>
        <button onclick="showSection('spiritual')">Back</button>
    </section>

    <section id="joyful-rosary" class="hidden">
        <h2>Joyful Mysteries</h2>
        <div id="joyful-display"></div>
        <button onclick="nextPrayer('joyful')">Next</button>
        <button onclick="showSection('rosary')">Back to Mysteries</button>
        <button onclick="showSection('main')">Back to Main Menu</button>
    </section>

    <section id="sorrowful-rosary" class="hidden">
        <h2>Sorrowful Mysteries</h2>
        <div id="sorrowful-display"></div>
        <button onclick="nextPrayer('sorrowful')">Next</button>
        <button onclick="showSection('rosary')">Back to Mysteries</button>
        <button onclick="showSection('main')">Back to Main Menu</button>
    </section>

    <section id="glorious-rosary" class="hidden">
        <h2>Glorious Mysteries</h2>
        <div id="glorious-display"></div>
        <button onclick="nextPrayer('glorious')">Next</button>
        <button onclick="showSection('rosary')">Back to Mysteries</button>
        <button onclick="showSection('main')">Back to Main Menu</button>
    </section>

    <section id="luminous-rosary" class="hidden">
        <h2>Luminous Mysteries</h2>
        <div id="luminous-display"></div>
        <button onclick="nextPrayer('luminous')">Next</button>
        <button onclick="showSection('rosary')">Back to Mysteries</button>
        <button onclick="showSection('main')">Back to Main Menu</button>
    </section>

<section id="prayers" class="hidden">
        <h2 id="prayer-title">Common Catholic Prayers</h2>
        <ul id="prayers-list">
            <li><button onclick="showPrayer('Sign of the Cross')">Sign of the Cross</button></li>
            <li><button onclick="showPrayer('Our Father')">Our Father</button></li>
            <li><button onclick="showPrayer('Hail Mary')">Hail Mary</button></li>
            <li><button onclick="showPrayer('Glory Be')">Glory Be</button></li>
            <li><button onclick="showPrayer('Apostles\' Creed')">Apostles' Creed</button></li>
            <li><button onclick="showPrayer('Nicene Creed')">Nicene Creed</button></li>
            <li><button onclick="showPrayer('Act of Contrition')">Act of Contrition</button></li>
            <li><button onclick="showPrayer('Hail Holy Queen')">Hail Holy Queen</button></li>
            <li><button onclick="showPrayer('Memorare')">Memorare</button></li>
            <li><button onclick="showPrayer('Angelus')">Angelus</button></li>
            <li><button onclick="showPrayer('Prayer to St. Michael')">Prayer to St. Michael</button></li>
            <li><button onclick="showPrayer('Anima Christi')">Anima Christi</button></li>
            <li><button onclick="showPrayer('Guardian Angel Prayer')">Guardian Angel Prayer</button></li>
            <li><button onclick="showPrayer('Grace Before Meals')">Grace Before Meals</button></li>
            <li><button onclick="showPrayer('Grace After Meals')">Grace After Meals</button></li>
            <li><button onclick="showPrayer('Morning Offering')">Morning Offering</button></li>
            <li><button onclick="showPrayer('Act of Faith')">Act of Faith</button></li>
            <li><button onclick="showPrayer('Act of Hope')">Act of Hope</button></li>
            <li><button onclick="showPrayer('Act of Love')">Act of Love</button></li>
            <li><button onclick="showPrayer('Fatima Prayer')">Fatima Prayer</button></li>
            <li><button onclick="showPrayer('Come Holy Spirit')">Come Holy Spirit</button></li>
            <li><button onclick="showPrayer('Eternal Rest')">Eternal Rest</button></li>
            <li><button onclick="showPrayer('Divine Praises')">Divine Praises</button></li>
            <li><button onclick="showPrayer('Confiteor')">Confiteor</button></li>
        </ul>
        <pre id="prayer-text" class="hidden"></pre>
        <button onclick="resetPrayer()">Back to List</button>
        <button onclick="showSection('spiritual')">Back to Spiritual Menu</button>
    </section>

    <script>
        // Prayer texts
        const signOfCross = ".";
        const apostlesCreed = ".";
        const ourFather = ".";
        const hailMary = ".";
        const gloryBe = ".";
		const fatima = ". Amen";
		const hailholyqueen = "."
		
        // Mysteries with scripture
        const joyfulMysteries = [
            {name: "The Annunciation", scripture: "Luke 1:26-38\n\n"},
            {name: "The Visitation", scripture: "Luke 1:39-56\n\n"},
            {name: "The Nativity", scripture: "Luke 2:1-20\n\n"},
            {name: "The Presentation", scripture: "Luke 2:22-38\n\n"},
            {name: "The Finding in the Temple", scripture: "Luke 2:41-52\n\n"}
        ];

        const sorrowfulMysteries = [
            {name: "The Agony in the Garden", scripture: "Luke 22:39-46\n\n”"},
            {name: "The Scourging at the Pillar", scripture: "John 19:1\n\n"},
            {name: "The Crowning with Thorns", scripture: "Matthew 27:27-31\n\n"},
            {name: "The Carrying of the Cross", scripture: "John 19:16-17\n\n"},
            {name: "The Crucifixion", scripture: "John 19:18-30\n\n"}
        ];

        const gloriousMysteries = [
            {name: "The Resurrection", scripture: "Matthew 28:1-10\n\n"},
            {name: "The Ascension", scripture: "Acts 1:6-11\n\n”"},
            {name: "The Descent of the Holy Spirit", scripture: "Acts 2:1-11\n\n”"},
            {name: "The Assumption", scripture: "Luke 1:46-55\n\n”"},
            {name: "The Coronation of Mary", scripture: "Revelation 12:1\n\n"}
        ];

        const luminousMysteries = [
            {name: "The Baptism of Christ in the Jordan", scripture: "Matthew 3:13-17\n\n.”"},
            {name: "The Wedding Feast at Cana", scripture: "John 2:1-11\n\n"},
            {name: "Jesus' Proclamation of the Kingdom of God", scripture: "Matthew 5:1-12\n\n”"},
            {name: "The Transfiguration", scripture: "Matthew 17:1-9\n\n”"},
            {name: "The Institution of the Eucharist", scripture: "Luke 22:14-20\n\n”"}
        ];

        // Global rosary states
    let rosaryStates = {};

    function ordinal(n) {
        const ord = ['First', 'Second', 'Third', 'Fourth', 'Fifth'];
        return ord[n - 1];
    }

    function startRosary(type) {
        let mysteries;
        let sectionId = type.toLowerCase() + '-rosary';
        let displayId = type.toLowerCase() + '-display';
        switch (type) {
            case 'Joyful': mysteries = joyfulMysteries; break;
            case 'Sorrowful': mysteries = sorrowfulMysteries; break;
            case 'Glorious': mysteries = gloriousMysteries; break;
            case 'Luminous': mysteries = luminousMysteries; break;
        }
        showSection(sectionId);

        let sequence = [];
        sequence.push({type: 'prayer', name: 'Sign of the Cross', text: signOfCross});
        sequence.push({type: 'prayer', name: 'Apostles\' Creed', text: apostlesCreed});
        sequence.push({type: 'prayer', name: 'Our Father', text: ourFather});
        for (let i = 0; i < 3; i++) sequence.push({type: 'prayer', name: 'Hail Mary', text: hailMary, count: i + 1, total: 3});
        sequence.push({type: 'prayer', name: 'Glory Be', text: gloryBe});
        for (let m = 0; m < 5; m++) {
            sequence.push({type: 'mystery', name: `${ordinal(m + 1)} ${type} Mystery: ${mysteries[m].name}`, scripture: mysteries[m].scripture});
            sequence.push({type: 'prayer', name: 'Our Father', text: ourFather});
            for (let i = 0; i < 10; i++) sequence.push({type: 'prayer', name: 'Hail Mary', text: hailMary, count: i + 1, total: 10});
            sequence.push({type: 'prayer', name: 'Glory Be', text: gloryBe});
            sequence.push({type: 'prayer', name: 'Fatima Prayer', text: fatima});
        }
        sequence.push({type: 'prayer', name: 'Hail Holy Queen', text: hailholyqueen});

        rosaryStates[type.toLowerCase()] = {sequence: sequence, index: 0, displayId: displayId};
        displayCurrentPrayer(type.toLowerCase());
    }

    function nextPrayer(type) {
        let state = rosaryStates[type];
        if (!state) return;
        state.index++;
        if (state.index >= state.sequence.length) {
            document.getElementById(state.displayId).innerHTML = '<p>Rosary Completed. Amen.</p>';
            return;
        }
        displayCurrentPrayer(type);
    }

    function displayCurrentPrayer(type) {
        let state = rosaryStates[type];
        let item = state.sequence[state.index];
        let html = '';
        if (item.type === 'mystery') {
            html = `<h3>${item.name}</h3><pre>${item.scripture}</pre>`;
        } else {
            let prayerName = item.name;
            if (item.count) {
                prayerName += ` (${item.count}/${item.total})`;
            }
            html = `<h3>${prayerName}</h3><pre>${item.text}</pre>`;
        }
        document.getElementById(state.displayId).innerHTML = html;
    }
</script>

    <section id="prayers" class="hidden">
        <h2 id="prayer-title">Common Catholic Prayers</h2>
        <ul id="prayers-list">
            <li><button onclick="showPrayer('Sign of the Cross')">Sign of the Cross</button></li>
            <li><button onclick="showPrayer('Our Father')">Our Father</button></li>
            <li><button onclick="showPrayer('Hail Mary')">Hail Mary</button></li>
            <li><button onclick="showPrayer('Glory Be')">Glory Be</button></li>
            <li><button onclick="showPrayer('Apostles\' Creed')">Apostles' Creed</button></li>
            <li><button onclick="showPrayer('Nicene Creed')">Nicene Creed</button></li>
            <li><button onclick="showPrayer('Act of Contrition')">Act of Contrition</button></li>
            <li><button onclick="showPrayer('Hail Holy Queen')">Hail Holy Queen</button></li>
            <li><button onclick="showPrayer('Memorare')">Memorare</button></li>
            <li><button onclick="showPrayer('Angelus')">Angelus</button></li>
            <li><button onclick="showPrayer('Prayer to St. Michael')">Prayer to St. Michael</button></li>
            <li><button onclick="showPrayer('Anima Christi')">Anima Christi</button></li>
            <li><button onclick="showPrayer('Guardian Angel Prayer')">Guardian Angel Prayer</button></li>
            <li><button onclick="showPrayer('Grace Before Meals')">Grace Before Meals</button></li>
            <li><button onclick="showPrayer('Grace After Meals')">Grace After Meals</button></li>
            <li><button onclick="showPrayer('Morning Offering')">Morning Offering</button></li>
            <li><button onclick="showPrayer('Act of Faith')">Act of Faith</button></li>
            <li><button onclick="showPrayer('Act of Hope')">Act of Hope</button></li>
            <li><button onclick="showPrayer('Act of Love')">Act of Love</button></li>
            <li><button onclick="showPrayer('Fatima Prayer')">Fatima Prayer</button></li>
            <li><button onclick="showPrayer('Come Holy Spirit')">Come Holy Spirit</button></li>
            <li><button onclick="showPrayer('Eternal Rest')">Eternal Rest</button></li>
            <li><button onclick="showPrayer('Divine Praises')">Divine Praises</button></li>
            <li><button onclick="showPrayer('Confiteor')">Confiteor</button></li>
        </ul>
        <pre id="prayer-text" class="hidden"></pre>
        <button onclick="resetPrayer()">Back to List</button>
        <button onclick="showSection('spiritual')">Back to Spiritual Menu</button>
    </section>
    
    

        <!-- The Integrated Chat Section -->
        <section id="chat-section" class="hidden">
            <h2>O.C.I.A. Chat</h2>
            <div class="chat-container">
                <div class="chat-header">
                    Community Chat
                </div>

                <div id="user-status-area" class="user-status-area">
                    <span id="welcome-message"></span>
                    <span id="current-class-display"></span>
                    <div id="username-class-input-area" class="hidden">
                        <input type="text" id="username-input" placeholder="Enter your username">
                        <input type="text" id="class-input" placeholder="Enter your Class Name (e.g., OCIA 1)">
                        <button id="save-profile-button">Save Profile</button>
                    </div>
                </div>

                <div id="messages-area" class="messages-area">
                    <div id="loading-indicator" class="loading-message">Loading chat...</div>
                </div>
                <div class="input-area">
                    <input type="text" id="message-input" placeholder="Type your message...">
                    <button id="send-button">Send</button>
                </div>
                <!-- The close button might be less relevant for an integrated section, but kept for now -->
                <button id="close-chat-button">X</button> 
            </div>
        </section>

        <section id="quit-section" class="hidden">
            <h2>Quit</h2>
            <!-- Quit content or confirmation -->
            <p>Thank you for using the app. You can close this window.</p>
        </section>
    </div> <!-- End of .main-content-container -->


    <!-- Custom Alert Modal Structure -->
    <div id="custom-alert-modal" class="hidden">
        <div class="alert-message"></div>
        <button class="alert-ok-button">OK</button>
    </div>

    <!-- Alert Overlay for Custom Alert -->
    <div id="alert-overlay"></div>
    
    <script type="module">
        // Firebase SDK imports for modular syntax
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, getDoc, setDoc, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration (from your Firebase Console)
        const firebaseConfig = {
            apiKey: "AIzaSyA7B17UFVuvxOUmK81MCkSwwTzXiXeySlk",
            authDomain: "ocia-application.firebaseapp.com",
            projectId: "ocia-application",
            storageBucket: "ocia-application.firebasestorage.app",
            messagingSenderId: "113168534647",
            appId: "1:113168534647:web:ac363f4f89185b6ac88a72",
            measurementId: "G-WRGSXQCY5D"
        };

        // Initialize Firebase (only once for the entire app)
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables for chat logic (from Canvas environment, if available)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let currentUserId = null;
        let currentUsername = 'Anonymous'; // Default username
        let currentClassId = null; // New variable for class ID
        let isAuthReady = false;

        // --- Custom Alert Modal Functions ---
        const customAlertModal = document.getElementById('custom-alert-modal');
        const alertMessageElement = customAlertModal.querySelector('.alert-message');
        const alertOkButton = customAlertModal.querySelector('.alert-ok-button');
        const alertOverlay = document.getElementById('alert-overlay'); // Dedicated overlay for alert

        function showAlert(message) {
            alertMessageElement.textContent = message;
            customAlertModal.classList.remove('hidden');
            alertOverlay.classList.add('active'); // Activate the alert overlay
        }

        alertOkButton.addEventListener('click', () => {
            customAlertModal.classList.add('fade-out');
            customAlertModal.addEventListener('animationend', () => {
                customAlertModal.classList.add('hidden');
                customAlertModal.classList.remove('fade-out');
                alertOverlay.classList.remove('active'); // Deactivate the alert overlay
            }, { once: true }); // Ensure listener is removed after animation
        });


        // --- showSection function (moved to global scope for programmatic event listeners) ---
        // This function now handles both direct IDs and IDs ending with '-section'
        function showSection(sectionId) {
            console.log("showSection called with:", sectionId);
            // Hide all sections with a slight delay for transition
            document.querySelectorAll('.main-content-container section').forEach(section => {
                if (!section.classList.contains('hidden')) {
                    section.classList.add('hidden');
                    console.log("Added 'hidden' to:", section.id);
                }
            });

            // Find the target section
            let targetSection = document.getElementById(sectionId);
            if (!targetSection) {
                targetSection = document.getElementById(sectionId + '-section');
            }

            // Show the target section after a small delay to allow others to fade out
            if (targetSection) {
                setTimeout(() => {
                    targetSection.classList.remove('hidden');
                    console.log("Removed 'hidden' from:", targetSection.id);
                }, 100); // Small delay, adjust as needed based on transition duration
            } else {
                console.error("Target section not found with ID:", sectionId, "or", sectionId + '-section');
            }
        }

        // --- All other JavaScript logic wrapped in DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOMContentLoaded fired.");

            // Get chat elements within the chat section
            const messagesArea = document.querySelector('#chat-section #messages-area');
            const messageInput = document.querySelector('#chat-section #message-input');
            const sendButton = document.querySelector('#chat-section #send-button');
            const loadingIndicator = document.querySelector('#chat-section #loading-indicator');

            // Username/Class elements
            const welcomeMessageSpan = document.querySelector('#chat-section #welcome-message');
            const currentClassDisplay = document.querySelector('#chat-section #current-class-display');
            const usernameClassInputArea = document.querySelector('#chat-section #username-class-input-area');
            const usernameInput = document.querySelector('#chat-section #username-input');
            const classInput = document.querySelector('#chat-section #class-input');
            const saveProfileButton = document.querySelector('#chat-section #save-profile-button');

            // Startup animation elements
            const splashScreen = document.getElementById('splash-screen');
            const splashTitleBanner = document.getElementById('splash-title-banner');
            const mainContentContainer = document.querySelector('.main-content-container');

            // Hide main content initially (already done by CSS, but good to ensure)
            if (mainContentContainer) {
                mainContentContainer.style.display = 'none';
                mainContentContainer.classList.remove('visible'); // Ensure it's not visible
            }

            // Listen for the end of the title banner animation
            splashTitleBanner.addEventListener('animationend', () => {
                // Once the title banner animation is done, start fading out the whole splash screen
                splashScreen.classList.add('fade-out');
            });

 // Listen for the end of the splash screen fade-out
            splashScreen.addEventListener('transitionend', (e) => {
                if (e.propertyName === 'opacity') { // Ensure we only react to the opacity transition
                    // Once the splash screen has faded out, hide it completely
                    splashScreen.style.display = 'none';

                    if (mainContentContainer) {
                        // Trigger the fade-in for the main content by adding the 'visible' class
                        // The CSS transition on .main-content-container.visible will handle the smooth fade.
                        mainContentContainer.classList.add('visible');
                    }
                    // Removed the automatic showSection('lessons'); call here
                }
            }, { once: true }); // Ensure this listener only fires once


            /**
             * Initializes Firebase and sets up authentication.
             */
            async function initializeFirebaseChat() {
                console.log("initializeFirebaseChat called.");
                try {
                    // Listen for authentication state changes
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            currentUserId = user.uid;
                            console.log("Firebase authenticated. User ID:", currentUserId);
                            isAuthReady = true;

                            // Fetch user's profile (username and classId)
                            const userDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}`);
                            const userDocSnap = await getDoc(userDocRef);

                            if (userDocSnap.exists() && userDocSnap.data().username && userDocSnap.data().classId) {
                                currentUsername = userDocSnap.data().username;
                                currentClassId = userDocSnap.data().classId;
                                welcomeMessageSpan.textContent = `Welcome, ${currentUsername}!`;
                                currentClassDisplay.textContent = ` (Class: ${currentClassId})`;
                                usernameClassInputArea.classList.add('hidden'); // Hide input if profile exists
                                enableChatInput();
                            } else {
                                welcomeMessageSpan.textContent = `Welcome! Please set your profile:`;
                                currentClassDisplay.textContent = ''; // Clear class display
                                usernameClassInputArea.classList.remove('hidden'); // Show input if no profile
                                disableChatInput(); // Disable chat input until profile is set
                                // Pre-fill inputs if partial data exists (e.g., if only username was set before)
                                if (userDocSnap.exists()) {
                                    usernameInput.value = userDocSnap.data().username || '';
                                    classInput.value = userDocSnap.data().classId || '';
                                }
                            }

                            if (loadingIndicator) {
                                loadingIndicator.remove();
                            }
                            setupRealtimeListener(); // Always set up listener after auth, it will filter by classId
                        } else {
                            // This is the section to modify
                            try {
                                if (initialAuthToken) {
                                    // Attempt custom token sign-in first
                                    await signInWithCustomToken(auth, initialAuthToken);
                                    console.log("Signed in with custom token.");
                                } else {
                                    // Fallback to anonymous sign-in if no custom token
                                    await signInAnonymously(auth);
                                    console.log("Signed in anonymously.");
                                }
                            } catch (error) {
                                console.error("Error during initial sign-in attempt:", error);
                                // If custom token fails, try anonymous as a fallback
                                if (error.code === 'auth/custom-token-mismatch' || error.code === 'auth/invalid-custom-token') {
                                    console.warn("Custom token failed, attempting anonymous sign-in as fallback.");
                                    try {
                                        await signInAnonymously(auth);
                                        console.log("Signed in anonymously after custom token failure.");
                                    } catch (anonError) {
                                        console.error("Error signing in anonymously as fallback:", anonError);
                                        if (messagesArea) {
                                            messagesArea.innerHTML = `<div class="loading-message text-red-500">Error: Could not sign in. ${anonError.message}</div>`;
                                        }
                                    }
                                } else {
                                    // Other Firebase auth errors
                                    if (messagesArea) {
                                        messagesArea.innerHTML = `<div class="loading-message text-red-500">Error: Could not sign in. ${error.message}</div>`;
                                    }
                                }
                            }
                        }
                    });

                } catch (error) {
                    console.error("Error initializing Firebase Chat:", error);
                    if (messagesArea) {
                        messagesArea.innerHTML = `<div class="loading-message text-red-500">Error: Firebase Chat initialization failed. ${error.message}</div>`;
                    }
                }
            }

            /**
             * Saves the user's chosen username and class ID to Firestore.
             */
            async function saveProfile() {
                const newUsername = usernameInput.value.trim();
                const newClassId = classInput.value.trim();

                if (newUsername.length < 0) {
                    showAlert('Username must be at least 3 characters long.'); // Using custom alert
                    return;
                }
                if (newClassId.length < 0) {
                    showAlert('Class Name must be at least 2 characters long.'); // Using custom alert
                    return;
                }

                if (!currentUserId) {
                    console.error("Cannot save profile: User not authenticated.");
                    return;
                }

                try {
                    const userDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}`);
                    await setDoc(userDocRef, { username: newUsername, classId: newClassId }, { merge: true });
                    
                    currentUsername = newUsername;
                    currentClassId = newClassId; // Update currentClassId
                    
                    welcomeMessageSpan.textContent = `Welcome, ${currentUsername}!`;
                    currentClassDisplay.textContent = ` (Class: ${currentClassId})`;
                    usernameClassInputArea.classList.add('hidden'); // Hide input
                    enableChatInput(); // Enable chat input
                    console.log("User profile saved:", { username: newUsername, classId: newClassId });

                    // Re-setup listener to apply new class filter
                    setupRealtimeListener(); 

                } catch (error) {
                    console.error("Error saving profile:", error);
                    showAlert("Error saving profile. Please try again."); // Using custom alert
                }
            }

            /**
             * Enables the chat message input and send button.
             */
            function enableChatInput() {
                if (messageInput) messageInput.disabled = false;
                if (sendButton) sendButton.disabled = false;
            }

            /**
             * Disables the chat message input and send button.
             */
            function disableChatInput() {
                if (messageInput) messageInput.disabled = true;
                if (sendButton) sendButton.disabled = true;
            }

            /**
             * Sets up a real-time listener for messages from Firestore.
             */
            function setupRealtimeListener() {
                if (!db || !currentUserId || !currentClassId) {
                    console.warn("Firestore, User ID, or Class ID not ready for listener setup. Chat messages will not load.");
                    if (messagesArea) {
                         messagesArea.innerHTML = `<div class="loading-message">Please set your username and class to view chat messages.</div>`;
                    }
                    return;
                }

                const messagesCollectionRef = collection(db, `artifacts/${appId}/public/data/messages`);
                // Query messages where classId matches current user's classId
                const q = query(messagesCollectionRef, where('classId', '==', currentClassId), orderBy('timestamp', 'asc'));

                onSnapshot(q, (snapshot) => {
                    if (messagesArea) {
                        messagesArea.innerHTML = '';
                        if (snapshot.empty) {
                            messagesArea.innerHTML = `<div class="loading-message">No messages in this class yet. Be the first to say hello!</div>`;
                        }
                        snapshot.forEach((doc) => {
                            const message = doc.data();
                            displayMessage(message);
                        });
                        messagesArea.scrollTop = messagesArea.scrollHeight;
                    }
                }, (error) => {
                    console.error("Error listening to messages:", error);
                    if (messagesArea) {
                        messagesArea.innerHTML = `<div class="loading-message text-red-500">Error loading messages: ${error.message}</div>`;
                    }
                });
            }

            /**
             * Displays a single message in the chat area.
             * @param {object} message - The message object containing text, senderId, username, classId, and timestamp.
             */
            function displayMessage(message) {
                if (!messagesArea) return;

                const messageElement = document.createElement('div');
                messageElement.classList.add('message-bubble');

                const isSentByCurrentUser = message.senderId === currentUserId;
                if (isSentByCurrentUser) {
                    messageElement.classList.add('sent');
                } else {
                    messageElement.classList.add('received');
                }

                // Use username from message data, fallback to truncated senderId if somehow missing
                const senderDisplayName = message.username || (message.senderId ? `User: ${message.senderId.substring(0, 8)}...` : 'Unknown');
                
                const senderElement = document.createElement('div');
                senderElement.classList.add('message-sender');
                senderElement.textContent = senderDisplayName;
                messageElement.appendChild(senderElement);

                const textElement = document.createElement('div');
                textElement.textContent = message.text;
                messageElement.appendChild(textElement);

                messagesArea.appendChild(messageElement);
            }

            /**
             * Sends a new message to Firestore.
             */
            async function sendMessage() {
                if (!isAuthReady || !currentUserId || !messageInput || !currentUsername || currentUsername === 'Anonymous' || !currentClassId) {
                    console.warn("Firebase not ready, user not authenticated, username/class not set, or message input not found to send message.");
                    showAlert("Please set your username and class name before sending messages."); // Using custom alert
                    return;
                }

                const messageText = messageInput.value.trim();
                if (messageText === '') {
                    return;
                }

                try {
                    const messagesCollectionRef = collection(db, `artifacts/${appId}/public/data/messages`);
                    await addDoc(messagesCollectionRef, {
                        text: messageText,
                        senderId: currentUserId,
                        username: currentUsername,
                        classId: currentClassId, // Include the classId in the message
                        timestamp: serverTimestamp()
                    });
                    messageInput.value = '';
                } catch (error) {
                    console.error("Error sending message:", error);
                }
            }

            // Event listeners for sending messages
            if (sendButton) {
                sendButton.addEventListener('click', sendMessage);
            }
            if (messageInput) {
                messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }

            // Event listener for saving profile (username and class)
            if (saveProfileButton) {
                saveProfileButton.addEventListener('click', saveProfile);
            }
            if (usernameInput) {
                usernameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        saveProfile();
                    }
                });
            }
            if (classInput) {
                classInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        saveProfile();
                    }
                });
            }


            // --- Chat Section Toggle JavaScript ---
            const chatMenuButton = document.getElementById('chat-menu-button');
            const closeChatButton = document.getElementById('close-chat-button');
            // chatSection is no longer needed here as it's not directly toggling pointer-events for the alert.

            if (chatMenuButton) {
                chatMenuButton.addEventListener('click', () => showSection('chat-section'));
            } else {
                console.error("Chat menu button with ID 'chat-menu-button' not found.");
            }

            if (closeChatButton) {
                // For an integrated section, 'closing' means going back to lessons or spiritual formation
                closeChatButton.addEventListener('click', () => showSection('lessons-section')); // Default to lessons
            }


            // --- Attach event listeners for main navigation buttons ---
            const lessonsNavButton = document.getElementById('lessons-nav-button');
            const spiritualNavButton = document.getElementById('spiritual-nav-button');
            const resourcesNavButton = document.getElementById('resources-nav-button');
            const quitNavButton = document.getElementById('quit-nav-button');

            if (lessonsNavButton) {
                lessonsNavButton.addEventListener('click', () => showSection('lessons'));
            } else { console.error("Lessons nav button not found."); }

            if (spiritualNavButton) {
                spiritualNavButton.addEventListener('click', () => showSection('spiritual-formation'));
            } else { console.error("Spiritual nav button not found."); }

            if (resourcesNavButton) {
                resourcesNavButton.addEventListener('click', () => showSection('student-resources'));
            } else { console.error("Resources nav button not found."); }

            if (quitNavButton) {
                quitNavButton.addEventListener('click', () => {
                    showAlert("Thank you for using Catechumen! You can close this window.");
                });
            } else { console.error("Quit nav button not found."); }

            // Initialize Firebase chat logic after all elements and listeners are set up
            initializeFirebaseChat();
        }); // End of DOMContentLoaded listener

        // --- Prayer texts (globally accessible) ---
        // These are constants and do not rely on DOM elements, so can be outside DOMContentLoaded.
        const signOfCross = ".";
        const apostlesCreed = ".";
        const ourFather = ".";
        const hailMary = ".";
        const gloryBe = ".";
        const fatima = ".";
        const hailholyqueen = "."
        
        // Placeholder for missing rosary and prayer functions for brevity in this example.
        // You would have these functions already in your Catechism app.html
        function startQuiz() {
            showAlert("Starting quiz! (Functionality to be implemented)");
            console.log("Starting quiz.");
            // Implement quiz start logic
        }

        function submitQuiz() {
            showAlert("Submitting quiz! (Functionality to be implemented)");
            console.log("Submitting quiz.");
            // Implement quiz submission logic
        }

    </script>
</body>
</html>
