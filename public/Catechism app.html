<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catholic Faith Journey</title>
    <style>
        /* --- Existing Catechism App Styles --- */
        body {
            font-family: 'Georgia', serif;
            text-shadow: 1px 1px 4px #000;
            background-color: #3a6646;
            background-image: radial-gradient(50% 104%, #457654 46%, #21412A 100%);
            color: white;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
            min-height: 100vh; /* Ensure body takes full viewport height */
            display: flex;
            flex-direction: column;
            pointer-events: auto;
            overflow-x: hidden; /* Prevent horizontal scroll during animation */
        }

        header {
            text-align: center;
            background-color: #9C8547; /* Navy blue for Catholic theme */
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        header h1 {
            margin: 0;
            font-size: 2em;
        }
        
        nav {
            display: flex;
            justify-content: center;
            flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
            margin-bottom: 20px;
        }
        button {
            background-color: #7b6b30;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 1em;
            /* Enhanced Button Hover Effect */
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        button:hover {
            background-color: #5f5429;
            transform: translateY(-2px); /* Subtle lift effect */
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.2);
        }
        /* Main content sections container */
        .main-content-container {
            position: relative; /* Needed for absolute positioning of sections if they overlap */
            flex-grow: 1; /* Allows it to take up remaining vertical space */
            width: 100%;
            max-width: 900px; /* Match max-width of sections */
            margin: 0 auto; /* Center the container */
            display: flex; /* Use flex to manage sections within it */
            justify-content: center; /* Center sections horizontally */
            align-items: flex-start; /* Align sections to the top */
        }
        section {
            background: #9C8547;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            /* Smooth Section Transitions */
            opacity: 1;
            visibility: visible; /* Default visible */
            transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;
            
            position: absolute; /* Keep absolute for transitions, but manage parent */
            width: 100%; /* Take full width of its relative parent */
            top: 0; /* Align to top of parent */
            left: 0; /* Align to left of parent */
            box-sizing: border-box; /* Include padding in width */
        }
        /* The .hidden class is crucial for hiding sections with transitions */
        section.hidden {
            opacity: 0;
            visibility: hidden; /* Hide element visually and from screen readers */
            pointer-events: none; /* Disable interactions when hidden */
        }
        ul {
            list-style-type: none;
            padding: 0;
        }
        li {
            margin: 10px 0;
        }
        .quiz-question {
            margin-bottom: 20px;
        }
        .quiz-option {
            display: block;
            margin: 5px 0;
        }
        pre {
            white-space: pre-wrap;
            font-family: inherit;
        }
        .lesson-content {
            margin-bottom: 20px;
        }
        .video-placeholder {
            background-color: transparent;
            padding: 0;
            margin: 0;
            border: none;
            text-align: center;
            overflow: hidden;
        }

        /* --- Custom Alert Modal Styles --- */
        #custom-alert-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #ffffff;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            z-index: 10000; /* EXTREMELY HIGH */
            max-width: 350px;
            text-align: center;
            color: #333;
            animation: fadeIn 0.3s ease-out;
            pointer-events: auto;
        }
        #custom-alert-modal .alert-message {
            margin-bottom: 20px;
            font-size: 1.1em;
            font-weight: 500;
        }
        #custom-alert-modal .alert-ok-button {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }
        #custom-alert-modal .alert-ok-button:hover {
            background-color: #2563eb;
        }
        /* Animation for custom alert */
        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, -60%); }
            to { opacity: 1; transform: translate(-50%, -50%); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translate(-50%, -50%); }
            to { opacity: 0; transform: translate(-50%, -60%); }
        }
        .fade-out {
            animation: fadeOut 0.3s ease-out forwards;
        }

        /* Rule to hide the custom alert modal when it has the 'hidden' class */
        #custom-alert-modal.hidden {
            display: none;
        }

        /* Alert Overlay for Custom Alert */
        #alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* Slightly darker for alerts */
            z-index: 9999; /* Just below the custom alert */
            display: none; /* Hidden by default */
            pointer-events: auto;
        }
        #alert-overlay.active {
            display: block;
        }

        /* --- Integrated Chat Section Styles --- */
        #chat-section { /* Renamed from #chat-modal */
            width: 100%; /* Take full width of its parent .main-content-container */
            max-width: 900px; /* Match other sections */
            margin: 0 auto; /* Center it */
            height: auto; /* Allow height to adjust to content */
            min-height: 400px; /* Ensure some minimum height */
            background-color: #f0f0f0; /* Light background for the chat box */
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 1; /* Normal stacking context within main-content-container */
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Hide scrollbars if content overflows */
            padding: 20px; /* Inner padding */
            box-sizing: border-box; /* Include padding in width/height */
            color: #333; /* Dark text for readability on light background */
        }

        /* --- Chat Widget Inner Styles (adapted from your provided snippet) --- */
        #chat-section .chat-container { /* Target chat-container inside chat-section */
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 100%; /* Take full width of section */
            height: 100%; /* Take full height of section */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }
        #chat-section .chat-header { /* This was .p-4.bg-blue-600 in your snippet, adapted to a class */
            background-color: #3b82f6; /* Blue for chat header */
            color: white;
            text-align: center;
            font-size: 1.5em; /* Adjusted font size */
            font-weight: bold;
            padding: 1rem;
            border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
        }
        #chat-section .messages-area {
            flex-grow: 1;
            padding: 1.5rem;
            overflow-y: auto;
            max-height: none; /* Allow messages area to fill available space in section */
            min-height: 10rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            background-color: #f9fafb;
            border-bottom: 1px solid #e0e0e0;
        }
        #chat-section .message-bubble {
            max-width: 85%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            word-wrap: break-word;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        #chat-section .message-bubble.sent {
            background-color: #dbeafe;
            align-self: flex-end;
            color: #1e40af;
        }
        #chat-section .message-bubble.received {
            background-color: #f3f4f6;
            align-self: flex-start;
            color: #374151;
        }
        #chat-section .message-sender {
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: #6b7280;
        }
        #chat-section .input-area {
            padding: 1.5rem;
            display: flex;
            gap: 0.75rem;
            background-color: #ffffff;
            border-bottom-left-radius: 0.75rem; /* Match section border radius */
            border-bottom-right-radius: 0.75rem; /* Match section border radius */
        }
        #chat-section .input-area input {
            flex-grow: 1;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.75rem;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s;
        }
        #chat-section .input-area input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }
        #chat-section .input-area button {
            background-color: #3b82f6; /* Blue button */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        #chat-section .input-area button:hover {
            background-color: #2563eb;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        #chat-section .loading-message {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }
        #close-chat-button { /* Still needed if you want a close button within the integrated chat */
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #dc3545; /* Red for close button */
            color: white;
            border: none;
            border-radius: 50%; /* Make it round */
            width: 30px;
            height: 30px;
            font-size: 1em;
            line-height: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        #close-chat-button:hover {
            background-color: #c82333;
        }

        /* --- Username/Class Input Specific Styles --- */
        #chat-section .user-status-area {
            padding: 10px 15px;
            background-color: #e2e8f0; /* Light gray-blue */
            border-bottom: 1px solid #cbd5e0;
            text-align: center;
            font-size: 0.9em;
            color: #4a5568;
        }
        #chat-section #username-class-input-area { /* New ID for combined input area */
            display: flex;
            flex-direction: column; /* Stack inputs vertically */
            gap: 10px;
            justify-content: center;
            align-items: center;
            margin-top: 10px;
        }
        #chat-section #username-input,
        #chat-section #class-input { /* Apply styles to both inputs */
            padding: 8px 12px;
            border: 1px solid #a0aec0;
            border-radius: 5px;
            flex-grow: 1;
            width: 80%; /* Make them take more width */
            max-width: 250px; /* Limit input width */
        }
        #chat-section #save-profile-button { /* Renamed button */
            background-color: #48bb78; /* Green for save */
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
        #chat-section #save-profile-button:hover {
            background-color: #38a169;
        }

        /* --- Rosary Section Specific Styles --- */
        #rosary-section {
            background: #D4AF37; /* Gold/Brass color for rosary section */
            color: #333;
            text-align: center;
            padding: 30px;
            min-height: 300px; /* Ensure enough height for content */
            justify-content: flex-start; /* Align content to top within flex container */
        }
        #rosary-section h2 {
            font-size: 2.2em;
            margin-bottom: 20px;
            color: #6A0505; /* Deep red for titles */
        }
        #rosary-controls {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }
        #rosary-controls button {
            background-color: #8B4513; /* SaddleBrown for rosary buttons */
            color: white;
            padding: 12px 25px;
            font-size: 1.1em;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        #rosary-controls button:hover {
            background-color: #6A2800; /* Darker brown on hover */
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        #rosary-display {
            margin-top: 30px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 25px;
            border-radius: 10px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
            color: #333;
            text-align: left;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        #rosary-display h3 {
            font-size: 1.8em;
            color: #6A0505;
            margin-bottom: 15px;
            text-align: center;
        }
        #rosary-display p {
            font-size: 1.1em;
            line-height: 1.8;
            margin-bottom: 10px;
            text-align: center;
        }
        #rosary-display .scripture {
            font-style: italic;
            color: #555;
            margin-top: 15px;
            white-space: pre-wrap; /* Preserve line breaks in scripture */
        }
        #rosary-display .rosary-current-prayer {
            font-weight: bold;
            color: #21412A;
        }

        /* --- Startup Animation Styles (Canvas) --- */
        #animation-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #21412A; /* Dark background */
            z-index: 10001; /* Higher than everything else */
            opacity: 1;
            transition: opacity 1s ease-out; /* Only opacity for smooth fade */
            display: block; /* Ensure canvas is block-level */
        }
        #animation-canvas.fade-out {
            opacity: 0;
        }
        /* Hidden after fade-out to remove from layout and pointer events */
        #animation-canvas.hidden {
            display: none;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <!-- Startup Animation Canvas -->
    <canvas id="animation-canvas"></canvas>

    <header>
        <h1>Catholic Faith Journey</h1>
    </header>
    <nav>
        <button id="lessons-nav-button">Lessons (Progressive Instruction & Quizzes)</button>
        <button id="spiritual-nav-button">Spiritual Formation</button>
        <button id="chat-menu-button">Chat</button> <!-- This button now shows the integrated chat section -->
        <button id="resources-nav-button">Student Resources</button>
        <button id="quit-nav-button">Quit</button>
    </nav>

    <!-- Main content container for sections -->
    <div class="main-content-container">
        <section id="lessons-section">
            <h2>Lessons</h2>
            <!-- Lesson content goes here -->
            <p>This section will contain progressive instruction and quizzes.</p>
        </section>

        <section id="spiritual-formation-section" class="hidden">
            <h2>Spiritual Formation</h2>
            <p>Deepen your spiritual life with guided prayers and practices.</p>
            <button id="start-rosary-button">Pray the Rosary</button>
        </section>

        <section id="rosary-section" class="hidden">
            <h2>The Holy Rosary</h2>
            <div id="rosary-display">
                <h3 id="current-mystery-title"></h3>
                <p id="current-prayer-text" class="rosary-current-prayer"></p>
                <p id="current-scripture" class="scripture"></p>
            </div>
            <div id="rosary-controls">
                <button id="rosary-start-button">Start Rosary</button>
                <button id="rosary-next-button" class="hidden">Next Prayer</button>
                <button id="rosary-reset-button" class="hidden">Reset Rosary</button>
                <button id="rosary-back-to-spiritual-button">Back to Spiritual Formation</button>
            </div>
        </section>

        <section id="student-resources-section" class="hidden">
            <h2>Student Resources</h2>
            <!-- Student resources content goes here -->
            <p>Access helpful resources for your journey.</p>
        </section>

        <!-- The Integrated Chat Section -->
        <section id="chat-section" class="hidden">
            <h2>O.C.I.A. Chat</h2>
            <div class="chat-container">
                <div class="chat-header">
                    Community Chat
                </div>

                <div id="user-status-area" class="user-status-area">
                    <span id="welcome-message"></span>
                    <span id="current-class-display"></span>
                    <div id="username-class-input-area" class="hidden">
                        <input type="text" id="username-input" placeholder="Enter your username">
                        <input type="text" id="class-input" placeholder="Enter your Class Name (e.g., OCIA 1)">
                        <button id="save-profile-button">Save Profile</button>
                    </div>
                </div>

                <div id="messages-area" class="messages-area">
                    <div id="loading-indicator" class="loading-message">Loading chat...</div>
                </div>
                <div class="input-area">
                    <input type="text" id="message-input" placeholder="Type your message...">
                    <button id="send-button">Send</button>
                </div>
                <!-- The close button might be less relevant for an integrated section, but kept for now -->
                <button id="close-chat-button">X</button> 
            </div>
        </section>

        <section id="quit-section" class="hidden">
            <h2>Quit</h2>
            <!-- Quit content or confirmation -->
            <p>Thank you for using the app. You can close this window.</p>
        </section>
    </div> <!-- End of .main-content-container -->

    <!-- Custom Alert Modal Structure -->
    <div id="custom-alert-modal" class="hidden">
        <div class="alert-message"></div>
        <button class="alert-ok-button">OK</button>
    </div>

    <!-- Alert Overlay for Custom Alert -->
    <div id="alert-overlay"></div>


    <script type="module">
        // Firebase SDK imports for modular syntax
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, getDoc, setDoc, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration (from your Firebase Console)
        const firebaseConfig = {
            apiKey: "AIzaSyA7B17UFVuvxOUmK81MCkSwwTzXiXeySlk",
            authDomain: "ocia-application.firebaseapp.com",
            projectId: "ocia-application",
            storageBucket: "ocia-application.firebasestorage.app",
            messagingSenderId: "113168534647",
            appId: "1:113168534647:web:ac363f4f89185b6ac88a72",
            measurementId: "G-WRGSXQCY5D"
        };

        // Initialize Firebase (only once for the entire app)
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables for chat logic (from Canvas environment, if available)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let currentUserId = null;
        let currentUsername = 'Anonymous'; // Default username
        let currentClassId = null; // New variable for class ID
        let isAuthReady = false;

        // --- Custom Alert Modal Functions ---
        const customAlertModal = document.getElementById('custom-alert-modal');
        const alertMessageElement = customAlertModal.querySelector('.alert-message');
        const alertOkButton = customAlertModal.querySelector('.alert-ok-button');
        const alertOverlay = document.getElementById('alert-overlay'); // Dedicated overlay for alert

        function showAlert(message) {
            alertMessageElement.textContent = message;
            customAlertModal.classList.remove('hidden');
            alertOverlay.classList.add('active'); // Activate the alert overlay
        }

        alertOkButton.addEventListener('click', () => {
            customAlertModal.classList.add('fade-out');
            customAlertModal.addEventListener('animationend', () => {
                customAlertModal.classList.add('hidden');
                customAlertModal.classList.remove('fade-out');
                alertOverlay.classList.remove('active'); // Deactivate the alert overlay
            }, { once: true }); // Ensure listener is removed after animation
        });


        // --- showSection function (moved to global scope for programmatic event listeners) ---
        // This function now handles both direct IDs and IDs ending with '-section'
        function showSection(sectionId) {
            console.log("showSection called with:", sectionId);
            // Hide all sections with a slight delay for transition
            document.querySelectorAll('.main-content-container section').forEach(section => {
                if (!section.classList.contains('hidden')) {
                    section.classList.add('hidden');
                    console.log("Added 'hidden' to:", section.id);
                }
            });

            // Find the target section
            let targetSection = document.getElementById(sectionId);
            if (!targetSection) {
                targetSection = document.getElementById(sectionId + '-section');
            }

            // Show the target section after a small delay to allow others to fade out
            if (targetSection) {
                setTimeout(() => {
                    targetSection.classList.remove('hidden');
                    console.log("Removed 'hidden' from:", targetSection.id);
                }, 100); // Small delay, adjust as needed based on transition duration
            } else {
                console.error("Target section not found with ID:", sectionId, "or", sectionId + '-section');
            }
        }

        // --- All other JavaScript logic wrapped in DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOMContentLoaded fired.");

            // Get chat elements within the chat section
            const messagesArea = document.querySelector('#chat-section #messages-area');
            const messageInput = document.querySelector('#chat-section #message-input');
            const sendButton = document.querySelector('#chat-section #send-button');
            const loadingIndicator = document.querySelector('#chat-section #loading-indicator');

            // Username/Class elements
            const welcomeMessageSpan = document.querySelector('#chat-section #welcome-message');
            const currentClassDisplay = document.querySelector('#chat-section #current-class-display');
            const usernameClassInputArea = document.querySelector('#chat-section #username-class-input-area');
            const usernameInput = document.querySelector('#chat-section #username-input');
            const classInput = document.querySelector('#chat-section #class-input');
            const saveProfileButton = document.querySelector('#chat-section #save-profile-button');

            // Startup animation elements
            const animationCanvas = document.getElementById('animation-canvas');
            const ctx = animationCanvas.getContext('2d');
            let animationFrameId; // To store the requestAnimationFrame ID

            // Set canvas dimensions
            function resizeCanvas() {
                animationCanvas.width = window.innerWidth;
                animationCanvas.height = window.innerHeight;
            }
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas(); // Initial resize

            const OCIA_TEXT = "OCIA";
            const FONT_SIZE = 120; // Large font for impact
            const FONT_FAMILY = 'Georgia, serif';
            const TEXT_COLOR = 'white';
            const CROSS_COLOR = 'rgba(255, 255, 255, 0.7)'; // Semi-transparent white
            const CROSS_SIZE = 100; // Size of the cross

            // Letter objects for animation
            const letters = [];
            const finalPositions = []; // To store where each letter should end up

            // Calculate final positions for OCIA text (centered horizontally, above the cross)
            ctx.font = `${FONT_SIZE}px ${FONT_FAMILY}`;
            const textWidth = ctx.measureText(OCIA_TEXT).width;
            const startX = (animationCanvas.width / 2) - (textWidth / 2);
            const startY = (animationCanvas.height / 2) - (CROSS_SIZE / 2) - FONT_SIZE / 2 - 30; // Above cross, with some padding

            for (let i = 0; i < OCIA_TEXT.length; i++) {
                const char = OCIA_TEXT[i];
                const charWidth = ctx.measureText(char).width;
                const prevCharsWidth = ctx.measureText(OCIA_TEXT.substring(0, i)).width;
                finalPositions.push({
                    x: startX + prevCharsWidth + charWidth / 2, // Center of the character
                    y: startY + FONT_SIZE / 2 // Center of the character
                });

                // Initial random positions for letters (off-screen, from edges)
                const startEdge = Math.floor(Math.random() * 4); // 0: top, 1: right, 2: bottom, 3: left
                let initialX, initialY;
                if (startEdge === 0) { // Top
                    initialX = Math.random() * animationCanvas.width;
                    initialY = -FONT_SIZE;
                } else if (startEdge === 1) { // Right
                    initialX = animationCanvas.width + FONT_SIZE;
                    initialY = Math.random() * animationCanvas.height;
                } else if (startEdge === 2) { // Bottom
                    initialX = Math.random() * animationCanvas.width;
                    initialY = animationCanvas.height + FONT_SIZE;
                } else { // Left
                    initialX = -FONT_SIZE;
                    initialY = Math.random() * animationCanvas.height;
                }

                letters.push({
                    char: char,
                    x: initialX,
                    y: initialY,
                    vx: 0, // Start with 0 velocity, let spring/swirl pull them in
                    vy: 0,
                    opacity: 0,
                    scale: 0.5,
                    angle: Math.random() * Math.PI * 2, // Random initial rotation
                    targetX: finalPositions[i].x,
                    targetY: finalPositions[i].y,
                    swirlRadius: 150 + Math.random() * 100, // Random swirl radius
                    swirlAngleOffset: Math.random() * Math.PI * 2, // Random offset for swirl phase
                    swirlSpeed: 0.02 + Math.random() * 0.03 // Random swirl speed
                });
            }

            let animationStartTime;
            const ANIMATION_DURATION = 4000; // 4 seconds for the main animation

            function drawCross(x, y, size, color) {
                ctx.fillStyle = color;
                ctx.fillRect(x - size / 6, y - size / 2, size / 3, size); // Vertical bar
                ctx.fillRect(x - size / 2, y - size / 6, size, size / 3); // Horizontal bar
            }

            function animate(currentTime) {
                if (!animationStartTime) animationStartTime = currentTime;
                const elapsedTime = currentTime - animationStartTime;

                ctx.clearRect(0, 0, animationCanvas.width, animationCanvas.height);

                // Draw the cross silhouette
                drawCross(animationCanvas.width / 2, animationCanvas.height / 2, CROSS_SIZE, CROSS_COLOR);

                letters.forEach((letter, index) => {
                    const target = finalPositions[index];

                    // Swirling motion
                    const swirlX = Math.cos(elapsedTime * letter.swirlSpeed + letter.swirlAngleOffset) * letter.swirlRadius;
                    const swirlY = Math.sin(elapsedTime * letter.swirlSpeed + letter.swirlAngleOffset) * letter.swirlRadius;

                    // Attraction to target
                    const dx = target.x - letter.x;
                    const dy = target.y - letter.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);

                    // Apply physics if not close enough to target
                    if (distance > 1) { 
                        const springFactor = 0.02;
                        const friction = 0.95;
                        
                        letter.vx += dx * springFactor;
                        letter.vy += dy * springFactor;

                        // Add swirl to velocity, adjusted relative to canvas center
                        letter.vx += (swirlX - (letter.x - animationCanvas.width / 2)) * 0.001;
                        letter.vy += (swirlY - (letter.y - animationCanvas.height / 2)) * 0.001;

                        letter.vx *= friction;
                        letter.vy *= friction;

                        letter.x += letter.vx;
                        letter.y += letter.vy;

                        // Fade in and scale up
                        letter.opacity = Math.min(1, letter.opacity + 0.01);
                        letter.scale = Math.min(1, letter.scale + 0.01);

                        // Rotate
                        letter.angle += 0.05;
                    } else {
                        // Snap to final position and full opacity/scale if very close
                        letter.x = target.x;
                        letter.y = target.y;
                        letter.opacity = 1;
                        letter.scale = 1;
                        letter.angle = 0; // Stop rotation
                    }

                    ctx.save();
                    ctx.translate(letter.x, letter.y);
                    ctx.rotate(letter.angle);
                    ctx.scale(letter.scale, letter.scale);
                    ctx.globalAlpha = letter.opacity;
                    ctx.fillStyle = TEXT_COLOR;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.font = `${FONT_SIZE}px ${FONT_FAMILY}`;
                    ctx.fillText(letter.char, 0, 0);
                    ctx.restore();
                });

                // Main animation loop termination logic
                if (elapsedTime < ANIMATION_DURATION) {
                    animationFrameId = requestAnimationFrame(animate);
                } else {
                    // Force all letters to their final positions before fading out
                    letters.forEach(letter => {
                        letter.x = letter.targetX;
                        letter.y = letter.targetY;
                        letter.opacity = 1;
                        letter.scale = 1;
                        letter.angle = 0;
                    });
                    // Redraw one last time with final positions
                    ctx.clearRect(0, 0, animationCanvas.width, animationCanvas.height);
                    drawCross(animationCanvas.width / 2, animationCanvas.height / 2, CROSS_SIZE, CROSS_COLOR);
                    letters.forEach(letter => {
                        ctx.save();
                        ctx.translate(letter.x, letter.y);
                        ctx.rotate(letter.angle);
                        ctx.scale(letter.scale, letter.scale);
                        ctx.globalAlpha = letter.opacity;
                        ctx.fillStyle = TEXT_COLOR;
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.font = `${FONT_SIZE}px ${FONT_FAMILY}`;
                        ctx.fillText(letter.char, 0, 0);
                        ctx.restore();
                    });

                    // Animation complete, start fade out
                    animationCanvas.classList.add('fade-out');
                    animationCanvas.addEventListener('transitionend', () => {
                        animationCanvas.classList.add('hidden'); // Fully remove after fade
                        showSection('lessons'); // Show the initial section
                    }, { once: true });
                }
            }

            // Start the animation loop
            animationFrameId = requestAnimationFrame(animate);

            /**
             * Initializes Firebase and sets up authentication.
             */
            async function initializeFirebaseChat() {
                console.log("initializeFirebaseChat called.");
                try {
                    // Listen for authentication state changes
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            currentUserId = user.uid;
                            console.log("Firebase authenticated. User ID:", currentUserId);
                            isAuthReady = true;

                            // Fetch user's profile (username and classId)
                            const userDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}`);
                            const userDocSnap = await getDoc(userDocRef);

                            if (userDocSnap.exists() && userDocSnap.data().username && userDocSnap.data().classId) {
                                currentUsername = userDocSnap.data().username;
                                currentClassId = userDocSnap.data().classId;
                                welcomeMessageSpan.textContent = `Welcome, ${currentUsername}!`;
                                currentClassDisplay.textContent = ` (Class: ${currentClassId})`;
                                usernameClassInputArea.classList.add('hidden'); // Hide input if profile exists
                                enableChatInput();
                            } else {
                                welcomeMessageSpan.textContent = `Welcome! Please set your profile:`;
                                currentClassDisplay.textContent = ''; // Clear class display
                                usernameClassInputArea.classList.remove('hidden'); // Show input if no profile
                                disableChatInput(); // Disable chat input until profile is set
                                // Pre-fill inputs if partial data exists (e.g., if only username was set before)
                                if (userDocSnap.exists()) {
                                    usernameInput.value = userDocSnap.data().username || '';
                                    classInput.value = userDocSnap.data().classId || '';
                                }
                            }

                            if (loadingIndicator) {
                                loadingIndicator.remove();
                            }
                            setupRealtimeListener(); // Always set up listener after auth, it will filter by classId
                        } else {
                            // This is the section to modify
                            try {
                                if (initialAuthToken) {
                                    // Attempt custom token sign-in first
                                    await signInWithCustomToken(auth, initialAuthToken);
                                    console.log("Signed in with custom token.");
                                } else {
                                    // Fallback to anonymous sign-in if no custom token
                                    await signInAnonymously(auth);
                                    console.log("Signed in anonymously.");
                                }
                            } catch (error) {
                                console.error("Error during initial sign-in attempt:", error);
                                // If custom token fails, try anonymous as a fallback
                                if (error.code === 'auth/custom-token-mismatch' || error.code === 'auth/invalid-custom-token') {
                                    console.warn("Custom token failed, attempting anonymous sign-in as fallback.");
                                    try {
                                        await signInAnonymously(auth);
                                        console.log("Signed in anonymously after custom token failure.");
                                    } catch (anonError) {
                                        console.error("Error signing in anonymously as fallback:", anonError);
                                        if (messagesArea) {
                                            messagesArea.innerHTML = `<div class="loading-message text-red-500">Error: Could not sign in. ${anonError.message}</div>`;
                                        }
                                    }
                                } else {
                                    // Other Firebase auth errors
                                    if (messagesArea) {
                                        messagesArea.innerHTML = `<div class="loading-message text-red-500">Error: Could not sign in. ${error.message}</div>`;
                                    }
                                }
                            }
                        }
                    });

                } catch (error) {
                    console.error("Error initializing Firebase Chat:", error);
                    if (messagesArea) {
                        messagesArea.innerHTML = `<div class="loading-message text-red-500">Error: Firebase Chat initialization failed. ${error.message}</div>`;
                    }
                }
            }

            /**
             * Saves the user's chosen username and class ID to Firestore.
             */
            async function saveProfile() {
                const newUsername = usernameInput.value.trim();
                const newClassId = classInput.value.trim();

                if (newUsername.length < 3) {
                    showAlert('Username must be at least 3 characters long.'); // Using custom alert
                    return;
                }
                if (newClassId.length < 2) {
                    showAlert('Class Name must be at least 2 characters long.'); // Using custom alert
                    return;
                }

                if (!currentUserId) {
                    console.error("Cannot save profile: User not authenticated.");
                    return;
                }

                try {
                    const userDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}`);
                    await setDoc(userDocRef, { username: newUsername, classId: newClassId }, { merge: true });
                    
                    currentUsername = newUsername;
                    currentClassId = newClassId; // Update currentClassId
                    
                    welcomeMessageSpan.textContent = `Welcome, ${currentUsername}!`;
                    currentClassDisplay.textContent = ` (Class: ${currentClassId})`;
                    usernameClassInputArea.classList.add('hidden'); // Hide input
                    enableChatInput(); // Enable chat input
                    console.log("User profile saved:", { username: newUsername, classId: newClassId });

                    // Re-setup listener to apply new class filter
                    setupRealtimeListener(); 

                } catch (error) {
                    console.error("Error saving profile:", error);
                    showAlert("Error saving profile. Please try again."); // Using custom alert
                }
            }

            /**
             * Enables the chat message input and send button.
             */
            function enableChatInput() {
                if (messageInput) messageInput.disabled = false;
                if (sendButton) sendButton.disabled = false;
            }

            /**
             * Disables the chat message input and send button.
             */
            function disableChatInput() {
                if (messageInput) messageInput.disabled = true;
                if (sendButton) sendButton.disabled = true;
            }

            /**
             * Sets up a real-time listener for messages from Firestore.
             */
            function setupRealtimeListener() {
                if (!db || !currentUserId || !currentClassId) {
                    console.warn("Firestore, User ID, or Class ID not ready for listener setup. Chat messages will not load.");
                    if (messagesArea) {
                         messagesArea.innerHTML = `<div class="loading-message">Please set your username and class to view chat messages.</div>`;
                    }
                    return;
                }

                const messagesCollectionRef = collection(db, `artifacts/${appId}/public/data/messages`);
                // Query messages where classId matches current user's classId
                const q = query(messagesCollectionRef, where('classId', '==', currentClassId), orderBy('timestamp', 'asc'));

                onSnapshot(q, (snapshot) => {
                    if (messagesArea) {
                        messagesArea.innerHTML = '';
                        if (snapshot.empty) {
                            messagesArea.innerHTML = `<div class="loading-message">No messages in this class yet. Be the first to say hello!</div>`;
                        }
                        snapshot.forEach((doc) => {
                            const message = doc.data();
                            displayMessage(message);
                        });
                        messagesArea.scrollTop = messagesArea.scrollHeight;
                    }
                }, (error) => {
                    console.error("Error listening to messages:", error);
                    if (messagesArea) {
                        messagesArea.innerHTML = `<div class="loading-message text-red-500">Error loading messages: ${error.message}</div>`;
                    }
                });
            }

            /**
             * Displays a single message in the chat area.
             * @param {object} message - The message object containing text, senderId, username, classId, and timestamp.
             */
            function displayMessage(message) {
                if (!messagesArea) return;

                const messageElement = document.createElement('div');
                messageElement.classList.add('message-bubble');

                const isSentByCurrentUser = message.senderId === currentUserId;
                if (isSentByCurrentUser) {
                    messageElement.classList.add('sent');
                } else {
                    messageElement.classList.add('received');
                }

                // Use username from message data, fallback to truncated senderId if somehow missing
                const senderDisplayName = message.username || (message.senderId ? `User: ${message.senderId.substring(0, 8)}...` : 'Unknown');
                
                const senderElement = document.createElement('div');
                senderElement.classList.add('message-sender');
                senderElement.textContent = senderDisplayName;
                messageElement.appendChild(senderElement);

                const textElement = document.createElement('div');
                textElement.textContent = message.text;
                messageElement.appendChild(textElement);

                messagesArea.appendChild(messageElement);
            }

            /**
             * Sends a new message to Firestore.
             */
            async function sendMessage() {
                if (!isAuthReady || !currentUserId || !messageInput || !currentUsername || currentUsername === 'Anonymous' || !currentClassId) {
                    console.warn("Firebase not ready, user not authenticated, username/class not set, or message input not found to send message.");
                    showAlert("Please set your username and class name before sending messages."); // Using custom alert
                    return;
                }

                const messageText = messageInput.value.trim();
                if (messageText === '') {
                    return;
                }

                try {
                    const messagesCollectionRef = collection(db, `artifacts/${appId}/public/data/messages`);
                    await addDoc(messagesCollectionRef, {
                        text: messageText,
                        senderId: currentUserId,
                        username: currentUsername,
                        classId: currentClassId, // Include the classId in the message
                        timestamp: serverTimestamp()
                    });
                    messageInput.value = '';
                } catch (error) {
                    console.error("Error sending message:", error);
                }
            }

            // Event listeners for sending messages
            if (sendButton) {
                sendButton.addEventListener('click', sendMessage);
                console.log("Send button event listener attached.");
            }
            if (messageInput) {
                messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
                console.log("Message input keypress listener attached.");
            }

            // Event listener for saving profile (username and class)
            if (saveProfileButton) {
                saveProfileButton.addEventListener('click', saveProfile);
                console.log("Save Profile button event listener attached.");
            }
            if (usernameInput) {
                usernameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        saveProfile();
                    }
                });
                console.log("Username input keypress listener attached.");
            }
            if (classInput) {
                classInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        saveProfile();
                    }
                });
                console.log("Class input keypress listener attached.");
            }


            // --- Chat Section Toggle JavaScript ---
            const chatMenuButton = document.getElementById('chat-menu-button');
            const closeChatButton = document.getElementById('close-chat-button');
            // chatSection is no longer needed here as it's not directly toggling pointer-events for the alert.

            if (chatMenuButton) {
                chatMenuButton.addEventListener('click', () => showSection('chat-section'));
                console.log("Chat menu button event listener attached.");
            } else {
                console.error("Chat menu button with ID 'chat-menu-button' not found.");
            }

            if (closeChatButton) {
                // For an integrated section, 'closing' means going back to lessons or spiritual formation
                closeChatButton.addEventListener('click', () => showSection('lessons-section')); // Default to lessons
                console.log("Close chat button event listener attached.");
            }


            // --- Attach event listeners for main navigation buttons ---
            const lessonsNavButton = document.getElementById('lessons-nav-button');
            const spiritualNavButton = document.getElementById('spiritual-nav-button');
            const resourcesNavButton = document.getElementById('resources-nav-button');
            const quitNavButton = document.getElementById('quit-nav-button');

            if (lessonsNavButton) {
                lessonsNavButton.addEventListener('click', () => showSection('lessons'));
                console.log("Lessons nav button listener attached.");
            } else { console.error("Lessons nav button not found."); }

            if (spiritualNavButton) {
                spiritualNavButton.addEventListener('click', () => showSection('spiritual-formation'));
                console.log("Spiritual nav button listener attached.");
            } else { console.error("Spiritual nav button not found."); }

            if (resourcesNavButton) {
                resourcesNavButton.addEventListener('click', () => showSection('student-resources'));
                console.log("Resources nav button listener attached.");
            } else { console.error("Resources nav button not found."); }

            if (quitNavButton) {
                quitNavButton.addEventListener('click', () => {
                    showAlert("Thank you for using Catholic Faith Journey! You can close this window.");
                    console.log("Quit app initiated.");
                });
                console.log("Quit nav button listener attached.");
            } else { console.error("Quit nav button not found."); }


            // --- Rosary Logic Initialization ---
            const rosaryStartButton = document.getElementById('rosary-start-button');
            const rosaryNextButton = document.getElementById('rosary-next-button');
            const rosaryResetButton = document.getElementById('rosary-reset-button');
            const rosaryBackToSpiritualButton = document.getElementById('rosary-back-to-spiritual-button');
            const currentMysteryTitle = document.getElementById('current-mystery-title');
            const currentPrayerText = document.getElementById('current-prayer-text');
            const currentScripture = document.getElementById('current-scripture');
            const startRosaryButton = document.getElementById('start-rosary-button'); // Button in spiritual-formation

            let currentMysteryIndex = 0;
            let currentPrayerIndex = 0;
            let currentDecade = 0; // 0-4 for the 5 decades

            // Rosary structure: (Mystery Name, Scripture, [Prayers for decade])
            // Each decade has 1 Our Father, 10 Hail Marys, 1 Glory Be, 1 Fatima
            const rosaryPrayersSequence = [
                { type: 'Our Father', text: ourFather },
                ...Array(10).fill({ type: 'Hail Mary', text: hailMary }),
                { type: 'Glory Be', text: gloryBe },
                { type: 'Fatima Prayer', text: fatima }
            ];

            // NOTE: You only provided Joyful Mysteries. If you want to cycle through all,
            // you'll need to add Luminous, Sorrowful, Glorious Mysteries here.
            const mysteries = [
                { type: 'Joyful', name: "The Annunciation", scripture: "Luke 1:26-38\n\nIn the sixth month the angel Gabriel was sent from God to a city of Galilee named Nazareth, to a virgin betrothed to a man whose name was Joseph, of the house of David; and the virgin's name was Mary. And he came to her and said, “Hail, full of grace, the Lord is with you!” But she was greatly troubled at the saying, and considered in her mind what sort of greeting this might be. And the angel said to her, “Do not be afraid, Mary, for you have found favor with God. And behold, you will conceive in your womb and bear a son, and you shall call his name Jesus. He will be great, and will be called the Son of the Most High; and the Lord God will give to him the throne of his father David, and he will reign over the house of Jacob for ever; and of his kingdom there will be no end.” And Mary said to the angel, “How can this be, since I have no husband?” And the angel said to her, “The Holy Spirit will come upon you, and the power of the Most High will overshadow you; therefore the child to be born will be called holy, the Son of God. And behold, your kinswoman Elizabeth in her old age has also conceived a son; and this is the sixth month with her who was called barren. For with God nothing will be impossible.” And Mary said, “Behold, I am the handmaid of the Lord; let it be to me according to your word.” And the angel departed from her."},
                { type: 'Joyful', name: "The Visitation", scripture: "Luke 1:39-56\n\nIn those days Mary arose and went with haste into the hill country, to a city of Judah, and she entered the house of Zechariah and greeted Elizabeth. And when Elizabeth heard the greeting of Mary, the babe leaped in her womb; and Elizabeth was filled with the Holy Spirit and she exclaimed with a loud cry, “Blessed are you among women, and blessed is the fruit of your womb! And why is this granted me, that the mother of my Lord should come to me? For behold, when the voice of your greeting came to my ears, the babe in my womb leaped for joy. And blessed is she who believed that there would be a fulfilment of what was spoken to her from the Lord.” And Mary said, “My soul magnifies the Lord, and my spirit rejoices in God my Savior, for he has regarded the low estate of his handmaiden. For behold, henceforth all generations will call me blessed; for he who is mighty has done great things for me, and holy is his name. And his mercy is on those who fear him"},
                {type: 'Joyful', name: "The Nativity", scripture: "Luke 2:1-20\n\nIn those days a decree went out from Caesar Augustus that all the world should be enrolled. This was the first enrollment, when Quirin′ius was governor of Syria. And all went to be enrolled, each to his own city. And Joseph also went up from Galilee, from the city of Nazareth, to Judea, to the city of David, which is called Bethlehem, because he was of the house and lineage of David, to be enrolled with Mary, his betrothed, who was with child. And while they were there, the days were completed for her to be delivered. And she gave birth to her first-born son, and wrapped him in swaddling clothes, and laid him in a manger, because there was no place for them in the inn. And in that region there were shepherds out in the field, keeping watch over their flock by night. And an angel of the Lord appeared to them, and the glory of the Lord shone around them, and they were greatly frightened. And the angel said to them, “Do not be afraid; for behold, I bring you good news of a great joy which will come to all the people; for to you is born this day in the city of David a Savior, who is Christ the Lord. And this will be a sign for you: you will find a babe wrapped in swaddling clothes and lying in a manger.” And suddenly there was with the angel a multitude of the heavenly host praising God and saying, “Glory to God in the highest, and on earth peace among men with whom he is pleased!” When the angels went away from them into heaven, the shepherds said to one another, “Let us go over to Bethlehem and see this thing that has happened, which the Lord has made known to us.” And they went with haste, and found Mary and Joseph, and the babe lying in a manger. And when they saw it, they made known the saying which had been told them concerning this child; and all who heard him wondered at what the shepherds told them. But Mary kept all these things, pondering them in her heart. And the shepherds returned, glorifying and praising God for all they had heard and seen, as it had been told them."},
                {type: 'Joyful', name: "The Presentation", scripture: "Luke 2:22-38\n\nAnd when the time came for their purification according to the law of Moses, they brought him up to Jerusalem to present him to the Lord (as it is written in the law of the Lord, “Every male that opens the womb shall be called holy to the Lord”) and to offer a sacrifice according to what is said in the law of the Lord, “a pair of turtledoves, or two young pigeons.” Now there was a man in Jerusalem, whose name was Simeon, and this man was righteous and devout, looking for the consolation of Israel; and the Holy Spirit was upon him. And it had been revealed to him by the Holy Spirit that he should not see death before he had seen the Lord's Christ. And inspired by the Spirit he came into the temple; and when the parents brought in the child Jesus, to do for him according to the custom of the law, he took him up in his arms and blessed God and said, “Lord, now lettest thou thy servant depart in peace, according to thy word; for mine eyes have seen thy salvation which thou hast prepared in the presence of all peoples, a light for revelation to the Gentiles, and for glory to thy people Israel.” And his father and his mother marveled at what was said about him; and Simeon blessed them and said to Mary his mother, “Behold, this child is set for the fall and rising of many in Israel, and for a sign that is spoken against (and a sword will pierce through your own soul also), that thoughts from many hearts may be revealed.” And there was a prophetess, Anna, the daughter of Phan′uel, of the tribe of Asher; she was of great age, having lived with her husband seven years from her virginity, and as a widow till she was eighty-four. She did not depart from the temple, worshiping with fasting and prayer night and day. And coming up at that very hour she gave thanks to God, and spoke of him to all who were looking for the redemption of Jerusalem."},
                {type: 'Joyful', name: "The Finding in the Temple", scripture: "Luke 2:41-52\n\nNow his parents went to Jerusalem every year at the feast of the Passover. And when he was twelve years old, they went up according to custom; and when the feast was ended, as they were returning, the boy Jesus stayed behind in Jerusalem. His parents did not know it, but supposing him to be in the company they traveled a day's journey, and then sought him among their kinsfolk and acquaintances; and when they did not find him, they returned to Jerusalem, seeking him. After three days they found him in the temple, sitting among the teachers, listening to them and asking them questions; and all who heard him were amazed at his understanding and his answers. And when they saw him they were astonished; and his mother said to him, “Son, why have you treated us so? Behold, your father and I have been looking for you anxiously.” And he said to them, “How is it that you sought me? Did you not know that I must be in my Father's house?” And they did not understand the saying which he spoke to them. He went down with them and came to Nazareth, and was obedient to them; and his mother kept all these things in her heart. And Jesus increased in wisdom and in stature, and in favor with God and man."}
            ];

            function initializeRosary() {
                currentMysteryIndex = 0;
                currentPrayerIndex = 0;
                currentDecade = 0;
                displayCurrentRosaryPrayer();
                rosaryStartButton.classList.add('hidden');
                rosaryNextButton.classList.remove('hidden');
                rosaryResetButton.classList.remove('hidden');
            }

            function displayCurrentRosaryPrayer() {
                // If all mysteries are completed
                if (currentMysteryIndex >= mysteries.length) {
                    currentMysteryTitle.textContent = "Rosary Completed!";
                    currentPrayerText.textContent = "Praise be to God! You have completed the Rosary.";
                    currentScripture.textContent = "";
                    rosaryNextButton.classList.add('hidden');
                    showAlert("Congratulations! You have completed the Holy Rosary.");
                    return;
                }

                const mystery = mysteries[currentMysteryIndex];
                currentMysteryTitle.textContent = `${currentMysteryIndex + 1}. ${mystery.name} (${mystery.type} Mystery)`;
                currentScripture.textContent = mystery.scripture;

                // Handle advancing through prayers within a decade
                if (currentPrayerIndex < rosaryPrayersSequence.length) {
                    const prayer = rosaryPrayersSequence[currentPrayerIndex];
                    currentPrayerText.textContent = `${prayer.type}: ${prayer.text}`;
                } else {
                    // If all prayers in the current decade are done, move to next decade/mystery
                    currentPrayerIndex = 0; // Reset prayer index for next decade
                    currentDecade++;

                    if (currentDecade < 5) { // 5 decades in a rosary
                        currentMysteryIndex++; // Move to next mystery for the next decade
                        // If we run out of mysteries before 5 decades (e.g., only Joyful provided)
                        if (currentMysteryIndex >= mysteries.length) {
                            currentMysteryTitle.textContent = "Rosary Completed (Mysteries Exhausted)!";
                            currentPrayerText.textContent = "Praise be to God! You have completed the Rosary.";
                            currentScripture.textContent = "";
                            rosaryNextButton.classList.add('hidden');
                            showAlert("Congratulations! You have completed the Holy Rosary.");
                            return;
                        }
                        displayCurrentRosaryPrayer(); // Recurse to display next mystery/prayer
                    } else {
                        // Rosary completed (all 5 decades done)
                        currentMysteryTitle.textContent = "Rosary Completed!";
                        currentPrayerText.textContent = "Praise be to God! You have completed the Rosary.";
                        currentScripture.textContent = "";
                        rosaryNextButton.classList.add('hidden');
                        showAlert("Congratulations! You have completed the Holy Rosary.");
                    }
                }
            }

            function nextRosaryPrayer() {
                currentPrayerIndex++;
                displayCurrentRosaryPrayer();
            }

            function resetRosary() {
                initializeRosary();
            }

            // Event Listeners for Rosary Buttons
            if (startRosaryButton) {
                startRosaryButton.addEventListener('click', () => {
                    showSection('rosary'); // Show the rosary section
                    initializeRosary(); // Initialize the rosary state
                });
            }

            if (rosaryStartButton) {
                rosaryStartButton.addEventListener('click', initializeRosary);
            }
            if (rosaryNextButton) {
                rosaryNextButton.addEventListener('click', nextRosaryPrayer);
            }
            if (rosaryResetButton) {
                rosaryResetButton.addEventListener('click', resetRosary);
            }
            if (rosaryBackToSpiritualButton) {
                rosaryBackToSpiritualButton.addEventListener('click', () => showSection('spiritual-formation'));
            }

            // Initialize Firebase chat logic after all elements and listeners are set up
            initializeFirebaseChat();
        }); // End of DOMContentLoaded listener

        // --- Prayer texts (globally accessible) ---
        // These are constants and do not rely on DOM elements, so can be outside DOMContentLoaded.
        const signOfCross = "In the name of the Father, and of the Son, and of the Holy Spirit. Amen.";
        const apostlesCreed = "I believe in God, the Father almighty, Creator of heaven and earth, and in Jesus Christ, his only Son, our Lord, who was conceived by the Holy Spirit, born by the Virgin Mary, suffered under Pontius Pilate, was crucified, died and was buried; he descended into hell; on the third day he rose again from the dead; he ascended into heaven, and is seated at the right hand of God the Father almighty; from there he will come to judge the living and the dead. I believe in the Holy Spirit, the holy catholic Church, the communion of saints, the forgiveness of sins, the resurrection of the body, and life everlasting. Amen.";
        const ourFather = "Our Father, who art in heaven, hallowed be thy name; thy kingdom come; thy will be done on earth as it is in heaven. Give us this day our daily bread; and forgive us our trespasses as we forgive those who trespass against us; and lead us not into temptation, but deliver us from evil. Amen.";
        const hailMary = "Hail Mary, full of grace, the Lord is with thee; blessed art thou among women, and blessed is the fruit of thy womb, Jesus. Holy Mary, Mother of God, pray for us sinners, now and at the hour of our death. Amen.";
        const gloryBe = "Glory be to the Father, and to the Son, and to the Holy Spirit. As it was in the beginning, is now, and ever shall be, world without end. Amen.";
        const fatima = "O my Jesus, forgive us our sins, save us from the fires of hell, and lead all souls to heaven, especially those most in need of thy mercy. Amen";
        const hailholyqueen = "Hail, Holy Queen, Mother of Mercy, our life, our sweetness and our hope. To thee do we cry, poor banished children of Eve. To thee do we send up our sighs, mourning and weeping in this valley of tears. Turn, most gracious advocate, thine eyes of mercy toward us, and after this, our exile, show unto us the blessed fruit of thy womb, Jesus. O clement, O loving, O sweet Virgin Mary. Pray for us, O holy Mother of God. That we may be made worthy of the promises of Christ."
        
        // Placeholder for missing rosary and prayer functions for brevity in this example.
        // You would have these functions already in your Catechism app.html
        function startQuiz() {
            showAlert("Starting quiz! (Functionality to be implemented)");
            console.log("Starting quiz.");
            // Implement quiz start logic
        }

        function submitQuiz() {
            showAlert("Submitting quiz! (Functionality to be implemented)");
            console.log("Submitting quiz.");
            // Implement quiz submission logic
        }

    </script>
</body>
</html>
