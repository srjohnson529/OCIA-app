<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catechumen: Catholic Faith Formation App</title>
    <style>
        /* Global Styles */
       :root {
  --primary-color: #6d1718;       /* Deep red */
  --secondary-color: #bf944a;     /* Gold */
  --accent-color: #bf944a;        /* Use gold as your hover/highlight tone */
  --text-color: #f7f7f5;          /* Soft light text for dark background */
  --background-color: #110f0f;    /* Deep black/brown background */
  --background-gradient: radial-gradient(50% 104%, #6d1718 46%, #110f0f 100%);
  --font-family: 'Georgia', serif;
  --shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
  --border-radius: 8px;
  --transition: all 0.3s ease;
}

.button-theme {
  background: var(--primary-color);
  color: var(--text-color);
  padding: 0.75rem 1.25rem;
  border: none;
  border-radius: var(--border-radius);
  box-shadow: var(--shadow);
  cursor: pointer;
  transition: var(--transition);
  font-size: 1rem;
}

        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-family);
            color: var(--text-color);
            background: var(--background-gradient);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
            text-shadow: 1px 1px 4px #000; /* Added back from previous working code */
        }
        
        /* Header */
        header {
            background: var(--secondary-color);
            padding: 1rem;
            text-align: center;
            font-size: 2rem;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            border-radius: var(--border-radius); /* Added back from previous working code */
            margin-bottom: 1rem; /* Added back from previous working code */
        }

        /* Navigation Bar */
        nav {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
    gap: 1rem 2rem; /* vertical and horizontal gap */
    padding: 1rem 2rem;
    margin-bottom: 2rem;
    background-color: #8B0000; /* subtle background for visibility */
    border-radius: 0.5rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}


        nav button {
            background: var(--primary-color);
            color: var(--text-color);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: var(--transition);
            font-size: 1rem;
            min-width: 150px;
            text-align: center;
        }

        nav button {
    background: var(--primary-color);
    color: var(--text-color);
    border: none;
    padding: 0.75rem 1.75rem;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    cursor: pointer;
    transition: background 0.3s ease, transform 0.2s ease;
    font-size: 1rem;
    font-weight: 600;
    min-width: 140px;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    outline: none;
}

nav button:hover {
    background: var(--primary-color-hover, #0056b3); /* fallback if not set */
    transform: translateY(-2px);
}

nav button:active {
    transform: scale(0.97);
}

nav button:focus-visible {
    outline: 2px solid var(--focus-color, #ffc107);
    outline-offset: 3px;
}


       /* Main Content Container */
.main-content-container {
    position: relative;
    flex: 1 1 auto;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: center;
    padding: 0 1rem;
    max-width: 800px;
    width: 100%;
    margin: 0 auto;
    opacity: 1;
    transition: opacity 0.6s ease-in-out;
    background-color: var(--background-color, #21412A);
    border-radius: 0.75rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
    box-sizing: border-box;
}

/* Section Cards inside the Main Content */
.main-content-container section {
    width: 100%;
    max-width: 800px;
    margin: 2rem auto;
    padding: 2rem;
    background: var(--secondary-color, #c9a518); /* fallback color if var is undefined */
    border-radius: var(--border-radius, 0.75rem);
    box-shadow: var(--shadow, 0 4px 8px rgba(0, 0, 0, 0.1));
    text-align: center;
    font-size: 1.1rem;
    line-height: 1.6;
    color: white;
    box-sizing: border-box;
    transition: transform 0.3s ease, opacity 0.3s ease;
}

/* Hide Section Smoothly */
.main-content-container section.hidden {
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
    height: 0;
    overflow: hidden;
    margin: 0;
    padding: 0;
}


        /* Footer */
        footer {
            background: var(--primary-color); /* Adjusted to match previous working code */
            padding: 1rem;
            text-align: center;
            width: 100%; /* Added from previous working code */
            max-width: 900px; /* Added from previous working code */
            margin: 20px auto 0 auto; /* Adjusted margin from previous working code */
            border-radius: var(--border-radius); /* Added from previous working code */
            display: flex; /* Added from previous working code */
            justify-content: center; /* Added from previous working code */
            align-items: center; /* Added from previous working code */
        }

        footer nav {
            margin-bottom: 0; /* Ensure no extra margin */
        }

        footer button {
            background: var(--accent-color);
            color: var(--text-color);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: var(--transition);
        }

        footer button:hover {
            transform: translateY(-2px);
            background: var(--secondary-color); /* Adjusted hover color */
        }

       /* Overlay Behind the Modal */
#alert-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: none;
    z-index: 9999;
    pointer-events: auto;
}

#alert-overlay.active {
    display: block;
}

/* Modal Box */
#custom-alert-modal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.95);
    background: var(--background-color, #ffffff);
    padding: 2rem;
    border-radius: 0.75rem;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
    text-align: center;
    opacity: 0;
    transition: opacity 0.3s ease-out, transform 0.3s ease-out;
    z-index: 10000;
    max-width: 400px;
    width: 90%;
    color: #222;
    pointer-events: auto;
}

/* Visible Modal */
#custom-alert-modal.visible {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
}

/* Fade-Out Animation */
#custom-alert-modal.fade-out {
    animation: fadeOut 0.3s ease-out forwards;
}

/* Optional: Custom Fade Out Animation */
@keyframes fadeOut {

        @keyframes fadeIn { /* Added fadeIn keyframes */
            from { opacity: 0; transform: translate(-50%, -60%); }
            to { opacity: 1; transform: translate(-50%, -50%); }
        }
        @keyframes fadeOut { /* Added fadeOut keyframes */
            from { opacity: 1; transform: translate(-50%, -50%); }
            to { opacity: 0; transform: translate(-50%, -60%); }
        }


        #alert-message {
            margin-bottom: 20px; /* Adjusted margin */
            font-size: 1.1em; /* Adjusted font-size */
            font-weight: 500; /* Adjusted font-weight */
        }

        #alert-ok-button {
            background: #3b82f6; /* Blue button */
            color: white; /* White text */
            border: none;
            padding: 10px 20px; /* Adjusted padding */
            border-radius: 5px; /* Adjusted border-radius */
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }
        #alert-ok-button:hover {
            background: #5f5429; /* Darker blue on hover */
        }

        /* Section Specific Styles */
        #main-menu-section {
            text-align: center;
        }

        /* Lesson List Section */
#lessons-list-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10rem;
    padding: 1rem;
}
#lessons-list-section button.category-button:hover,
#lessons-list-section button.lesson-button:hover {
  transform: translateY(-2px);
  background: var(--accent-color, #c3a009);
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
}

/* Lessons List Section */
#lessons-list-section {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.75rem;
  padding: 1.5rem;
}

/* Lesson Content Wrapper */
#lesson-content-section {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 2rem 1rem;
  width: 100%;
  background-color: #ffffff;
  border-radius: 1rem;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
  max-width: 900px;
  margin: 2rem auto;
  box-sizing: border-box;
}

/* Individual Lesson Content */
#current-lesson-content {
  width: 100%;
  max-width: 700px;
  margin: 1rem 0;
  text-align: justify;
  line-height: 1.6;
  color: var(--text-color, #1f2937);
  font-size: 1rem;
}


/* Embedded Video Style */
.video-placeholder {
    width: 100%;
    max-width: 700px;
    aspect-ratio: 16 / 9;
    margin: 1.5rem 0;
    background-color: transparent;
    border: none;
    overflow: hidden;
}

.video-placeholder iframe {
    width: 100%;
    height: 100%;
    border: none;
}

/* Quiz Section */
#quiz-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1rem;
    width: 100%;
}

#quiz-questions-container {
    width: 90%;
    max-width: 700px;
    margin: 1rem 0;
}

/* Quiz Option Styling */
#quiz-questions-container label {
    display: flex;
    align-items: center;
    padding: 0.5rem;
    margin: 0.5rem 0;
    border-radius: 8px;
    background: #f5f5f5;
    cursor: pointer;
    transition: background 0.2s ease;
}

#quiz-questions-container label:hover {
    background: #e0e0e0;
}

#quiz-questions-container input[type="radio"] {
    margin-right: 0.75rem;
}


        #spiritual-formation-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    width: 100%;
    max-width: 700px;
    margin: 0 auto;
}

#spiritual-formation-section button {
    background: var(--primary-color);
    color: var(--text-color);
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    cursor: pointer;
    transition: background 0.3s ease, transform 0.2s ease;
    font-size: 1rem;
    min-width: 160px;
    width: 80%;
    max-width: 300px;
    text-align: center;
}

#spiritual-formation-section button:hover {
    transform: translateY(-2px);
    background: var(--accent-color);
}

        #rosary-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    background: #D4AF37; /* Rich gold */
    color: #333;
    text-align: center;
    padding: 2rem 1.5rem;
    min-height: 300px;
    width: 100%;
    box-sizing: border-box;
}

#rosary-section h2 {
    font-size: 2rem;
    margin-bottom: 1rem;
    color: #6A0505;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.15);
}

#rosary-section p {
    font-size: 1.1rem;
    line-height: 1.75;
    margin-bottom: 0.75rem;
    max-width: 700px;
}

#rosary-section button {
    background: #8B4513;
    color: white;
    padding: 0.75rem 1.5rem;
    font-size: 1.1rem;
    border: none;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    margin: 0.5rem;
    transition: background 0.3s ease, transform 0.2s ease;
    cursor: pointer;
}

#rosary-section button:hover {
    background: #5f5429;
    transform: translateY(-2px);
}


/* Container */
#chat-section {
  font-family: 'Inter', sans-serif;
  background-color: #f0f2f5;
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 1rem;
  box-sizing: border-box;
  width: 100%;
  position: relative; /* for close button positioning */
  z-index: 1;
}

/* Chat Card */
#chat-section .chat-container {
  background-color: #ffffff;
  border-radius: 1rem;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
  width: 100%;
  max-width: 42rem;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  border: 1px solid #e0e0e0;
  position: relative;
}

/* Header */
#chat-section .chat-header {
  background-color: var(--primary-color, #156c4c);
  color: white;
  text-align: center;
  padding: 1rem 1.5rem;
  font-size: 1.4rem;
  font-weight: bold;
  position: relative;
  z-index: 0;
}

/* Close Chat Button */
#close-chat-button {
  position: absolute;
  top: 1rem;
  right: 1rem;
  background-color: #dc3545;
  color: white;
  border: none;
  border-radius: 50%;
  width: 32px;
  height: 32px;
  font-size: 1rem;
  font-weight: bold;
  line-height: 1;
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
  transition: background-color 0.2s ease;
}

#close-chat-button:hover {
  background-color: #b02a37;
}

/* Profile Setup */
#profile-setup {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin: 0 1rem 1rem;
  padding: 1rem;
  background-color: #e2e8f0;
  border-radius: 0.5rem;
  text-align: center;
  font-size: 0.9rem;
  color: #4a5568;
  border: 1px solid #cbd5e0;
}

#profile-setup.hidden {
  display: none;
}

#profile-setup input {
  margin: 0.5rem 0;
  padding: 0.6rem;
  width: 100%;
  max-width: 300px;
  border-radius: 0.5rem;
  border: 1px solid #cbd5e0;
  font-size: 1rem;
  box-sizing: border-box;
}

#profile-setup button {
  background: var(--secondary-color, #c3a009);
  color: white;
  padding: 0.6rem 1.2rem;
  border-radius: 0.5rem;
  cursor: pointer;
  border: none;
  font-weight: 600;
  margin-top: 0.5rem;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  transition: background-color 0.2s, box-shadow 0.2s;
}

#profile-setup button:hover {
  background: #5f5429;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

/* Messages Area */
#chat-section .messages-area {
  flex-grow: 1;
  padding: 1.5rem;
  overflow-y: auto;
  max-height: 28rem;
  min-height: 10rem;
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  background-color: #f9fafb;
  border-top: 1px solid #e0e0e0;
  border-bottom: 1px solid #e0e0e0;
}

/* Message Bubbles */
#chat-section .message-bubble {
  max-width: 85%;
  padding: 0.75rem 1rem;
  border-radius: 1rem;
  word-wrap: break-word;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
  font-size: 0.95rem;
  line-height: 1.4;
}

#chat-section .message-bubble.sent {
  background-color: #dbeafe;
  align-self: flex-end;
  color: #1e40af;
  border-bottom-right-radius: 0.25rem;
}

#chat-section .message-bubble.received {
  background-color: #f3f4f6;
  align-self: flex-start;
  color: #374151;
  border-bottom-left-radius: 0.25rem;
}

#chat-section .message-sender {
  font-size: 0.75rem;
  font-weight: 600;
  margin-bottom: 0.25rem;
  color: #6b7280;
}

/* Input Area */
#chat-section .input-area {
  padding: 1rem 1.5rem;
  display: flex;
  gap: 0.75rem;
  background-color: #ffffff;
}

#chat-section .input-area input {
  flex-grow: 1;
  padding: 0.75rem 1rem;
  border: 1px solid #d1d5db;
  border-radius: 0.75rem;
  font-size: 1rem;
  outline: none;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

#chat-section .input-area input:focus {
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
}

/* Send Button */
#chat-section .input-area button {
  background-color: var(--secondary-color, #c3a009);
  color: white;
  padding: 0.75rem 1.5rem;
  border-radius: 0.75rem;
  font-weight: 600;
  cursor: pointer;
  transition: background-color 0.2s ease, box-shadow 0.2s ease;
  border: none;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

#chat-section .input-area button:hover {
  background-color: #9c7f00;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

/* Optional Loading State */
#chat-section .loading-message {
  text-align: center;
  padding: 2rem;
  color: #6b7280;
}


        #student-resources-section {
            text-align: center;
        }
        #student-resources-section button { /* Consistent button styling */
            background: var(--primary-color);
            color: var(--text-color);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: var(--transition);
            font-size: 1rem;
            min-width: 150px;
            margin: 0.5rem 0;
        }
        #student-resources-section button:hover {
            transform: translateY(-2px);
            background: var(--accent-color);
        }

        /* Responsiveness */
        @media (max-width: 768px) {
            nav {
                flex-direction: column;
            }

            nav button {
                width: 100%;
            }

            .main-content-container section {
                padding: 0.5rem;
            }
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header>Catechumen</header>

    <!-- Navigation Bar -->
    <nav>
        <button id="home-nav-button">Home</button>
        <button id="lessons-nav-button">Lessons & Quizzes</button>
        <button id="spiritual-nav-button">Spiritual Formation</button>
        <button id="chat-menu-button">Chat</button>
        <button id="resources-nav-button">Student Resources</button>
    </nav>

    <!-- Main Content Container -->
    <div class="main-content-container">
        <!-- Home Section -->
        <section id="main-menu-section">
            <h2>Welcome to Catechumen!</h2>
            <p>Use the navigation bar to explore lessons, spiritual exercises, and more.</p>
        </section>

        <!-- Lessons List Section -->
      <section id="lessons-list-section" class="hidden">
    <h2>Lessons Categories</h2>
    <div id="categories-container">
        <button class="button-theme category-button">The Profession of Faith</button>
        <button class="button-theme category-button">The Celebration of the Christian Mysteries</button>
        <button class="button-theme category-button">Life in Christ</button>
        <button class="button-theme category-button">Christian Prayer</button>
    </div>
    <div id="lessons-container" style="display: none;"></div>
<button class="button-theme" id="back-to-categories-button" style="display: none;">Back to Categories</button>
</section>

        <!-- Lesson Content Section -->
        <section id="lesson-content-section" class="hidden">
            <h2 id="current-lesson-title"></h2>
            <div id="current-lesson-content"></div>
            <div class="video-placeholder" id="lesson-video-container" style="display: none;">
                <iframe id="lesson-video" width="560" height="315" frameborder="0" allowfullscreen></iframe>
            </div>
            <button id="take-quiz-button">Take Quiz</button>
            <button id="back-to-lessons-list-button">Back to Lessons</button>
        </section>

        <!-- Quiz Section -->
        <section id="quiz-section" class="hidden">
            <h2 id="quiz-title"></h2>
            <div id="quiz-questions-container"></div>
            <button id="submit-quiz-button">Submit Quiz</button>
            <button id="back-to-lesson-from-quiz-button">Back to Lesson</button>
        </section>

        <!-- Spiritual Formation Section -->
        <section id="spiritual-formation-section" class="hidden">
            <h2>Spiritual Formation</h2>
            <button class="button-theme" id="lectio-divina-button">Lectio Divina</button>
            <button class="button-theme" id="guided-rosary-button">Guided Rosary</button>
            <button class="button-theme" id="common-prayers-button">Common Prayers</button>
            <button class="button-theme" id="liturgy-hours-button">Liturgy of the Hours</button>
            <button class="button-theme" id="spiritual-back-to-main-button">Back to Main Menu</button>
        </section>

        <!-- Rosary Section -->
        <section id="rosary-section" class="hidden">
            <h2 id="current-mystery-title"></h2>
            <p id="current-scripture"></p>
            <p id="current-prayer-text"></p>
            <button id="rosary-next-button">Next Prayer</button>
            <button id="rosary-reset-button">Reset Rosary</button>
            <button id="rosary-back-to-spiritual-button">Back to Spiritual Formation</button>
        </section>

        <!-- Chat Section -->
        <section id="chat-section" class="hidden">
            <div id="profile-setup" class="hidden"> <!-- Added hidden class by default -->
                <input id="username-input" type="text" placeholder="Enter Username">
                <input id="class-input" type="text" placeholder="Enter Class ID (e.g., OCIA 1)">
                <button class="button-theme" id="save-profile-button">Save Profile</button>
            </div>
            <h2 id="chat-header">Chat</h2>
            <div id="messages-area"></div>
            <div id="message-input-area">
                <input id="message-input" type="text" placeholder="Type your message...">
                <button class="button-theme" id="send-button">Send</button>
            </div>
            <button class="button-theme" id="close-chat-button">X</button>
        </section>

        <!-- Student Resources Section -->
        <section id="student-resources-section" class="hidden">
            <h2>Student Resources</h2>
            <p>Access helpful resources for your faith journey.</p>
            <button class="button-theme" onclick="window.open('https://bible.usccb.org/bible/readings/072525.cfm/', '_blank')">Holy Bible</button>
            <button class="button-theme" onclick="window.open('https://usccb.cld.bz/Catechism-of-the-Catholic-Church/', '_blank')">Catechism of the Catholic Church</button>
            <button class="button-theme" onclick="window.open('https://www.catholic.com/', '_blank')">Catholic Answers</button>
            <button class="button-theme" onclick="window.open('https://www.ibreviary.com/m2/breviario.php/', '_blank')">ibreviary</button>
            <button class="button-theme" onclick="window.open('https://media.ascensionpress.com/category/ascension-podcasts/catechisminayear/', '_blank')">The Catechism in a Year(with Fr. Mike Schmitz)</button>

        </section>
    </div>

    <!-- Footer -->
    <footer>
        <button id="quit-nav-button">Quit</button>
    </footer>

    <!-- Custom Alert Modal -->
    <div id="alert-overlay"></div>
    <div id="custom-alert-modal">
        <p id="alert-message"></p>
        <button id="alert-ok-button">OK</button>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Initialization
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            // Fallback config if undefined
            apiKey: "AIzaSyA7B17UFVuvxOUmK81MCkSwwTzXiXeySlk",
            authDomain: "ocia-application.firebaseapp.com",
            projectId: "ocia-application",
            storageBucket: "ocia-application.firebasestorage.app",
            messagingSenderId: "113168534647",
            appId: "1:113168534647:web:ac363f4f89185b6ac88a72",
            measurementId: "G-WRGSXQCY5D"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(app);
        const auth = firebase.auth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;


        // Global Variables
        let currentUser = null;
        let userProfile = null;
        let currentCategory = null;
        let currentLesson = null;
        let currentQuiz = null;

        // Sample Lessons Data (Dynamically generated categories)
        const lessonsData = [
            {
                category: "The Profession of Faith",
                lessons: [
                    {
                        id: "foundations-1",
                        title: "What is Faith?",
                        content: "Faith is the assurance of things hoped for, the conviction of things not seen.",
                        videoUrl: "https://www.youtube.com/embed/dQw4w9WgXcQ", // Example video
                        quiz: {
                            question: "What is faith?",
                            options: ["Assurance of things hoped for", "Seeing is believing", "A leap in the dark"],
                            correct: 0
                        }
                    },
                    {
                        id: "foundations-2",
                        title: "God the Father, Creator",
                        content: "Our journey continues by focusing on God the Father, the Almighty Creator of heaven and earth. He is the source of all that exists, visible and invisible.",
                        videoUrl: null,
                        quiz: {
                            question: "Who is the ultimate Creator of heaven and earth?",
                            options: ["Humanity", "Nature", "God the Father", "The universe itself"],
                            correct: 2
                        }
                    },
                ]
            },
            {
                category: "The Celebration of the Christian Mysteries",
                lessons: [
                    {
                        id: "trinity-1",
                        title: "Jesus Christ, Our Savior",
                        content: "In this lesson, we turn our hearts and minds to Jesus Christ, the Son of God, and our Savior. He is the central figure of our faith, through whom God revealed Himself most fully to humanity.",
                        videoUrl: "https://www.youtube.com/embed/3vuYCjfO_w4",
                        quiz: {
                            question: "What is the central event of Jesus Christ's life that is the cornerstone of Christian faith?",
                            options: ["His birth in Bethlehem", "His miracles", "His Resurrection", "His teachings"],
                            correct: 2
                        }
                    },
                    {
                        id: "trinity-2",
                        title: "The Holy Spirit",
                        content: "The Holy Spirit, the third Person of the Holy Trinity, is God's active presence in the world and in our lives. He is the Giver of Life, inspiring the prophets, empowering Jesus, and guiding the Church.",
                        videoUrl: null,
                        quiz: {
                            question: "What event marked the descent of the Holy Spirit upon the Apostles?",
                            options: ["The Annunciation", "The Nativity", "Pentecost", "The Ascension"],
                            correct: 2
                        }
                    },
                ]
            },
            {
                category: "Life in Christ",
                lessons: [
                    {
                        id: "church-1",
                        title: "The Holy Catholic Church",
                        content: "The Church is the Body of Christ, a community of believers called by God to continue His mission on earth. It is 'catholic,' meaning universal, embracing all people in all times and places.",
                        videoUrl: null,
                        quiz: {
                            question: "What does 'catholic' mean in reference to the Church?",
                            options: ["Strict and rigid", "Universal", "Small and exclusive", "Ancient and traditional"],
                            correct: 1
                        }
                    },
                ]
            },
            {
                category: "Christian Prayer",
                lessons: [
                    {
                        id: "sacraments-1",
                        title: "The Sacraments",
                        content: "The Sacraments are outward signs instituted by Christ to give grace. They are powerful encounters with God's saving presence, making visible the invisible reality of His love and mercy.",
                        videoUrl: null,
                        quiz: {
                            question: "How many Sacraments are there in the Catholic Church?",
                            options: ["Three", "Five", "Seven", "Ten"],
                            correct: 2
                        }
                    },
                ]
            },
            ];


        // Rosary Prayers Constants
        const SIGN_OF_THE_CROSS = "In the name of the Father, and of the Son, and of the Holy Spirit. Amen.";
        const APOSTLES_CREED = "I believe in God, the Father almighty, Creator of heaven and earth, and in Jesus Christ, his only Son, our Lord, who was conceived by the Holy Spirit, born by the Virgin Mary, suffered under Pontius Pilate, was crucified, died and was buried; he descended into hell; on the third day he rose again from the dead; he ascended into heaven, and is seated at the right hand of God the Father almighty; from there he will come to judge the living and the dead. I believe in the Holy Spirit, the holy catholic Church, the communion of saints, the forgiveness of sins, the resurrection of the body, and life everlasting. Amen.";
        const OUR_FATHER = "Our Father, who art in heaven, hallowed be thy name; thy kingdom come; thy will be done on earth as it is in heaven. Give us this day our daily bread; and forgive us our trespasses as we forgive those who trespass against us; and lead us not into temptation, but deliver us from evil. Amen.";
        const HAIL_MARY = "Hail Mary, full of grace, the Lord is with thee; blessed art thou among women, and blessed is the fruit of thy womb, Jesus. Holy Mary, Mother of God, pray for us sinners, now and at the hour of our death. Amen.";
        const GLORY_BE = "Glory be to the Father, and to the Son, and to the Holy Spirit. As it was in the beginning, is now, and ever shall be, world without end. Amen.";
        const FATIMA_PRAYER = "O my Jesus, forgive us our sins, save us from the fires of hell, and lead all souls to heaven, especially those most in need of thy mercy. Amen";
        const HAIL_HOLY_QUEEN = "Hail, Holy Queen, Mother of Mercy, our life, our sweetness and our hope. To thee do we cry, poor banished children of Eve. To thee do we send up our sighs, mourning and weeping in this valley of tears. Turn, most gracious advocate, thine eyes of mercy toward us, and after this, our exile, show unto us the blessed fruit of thy womb, Jesus. O clement, O loving, O sweet Virgin Mary. Pray for us, O holy Mother of God. That we may be made worthy of the promises of Christ.";

        // Joyful Mysteries
        const joyfulMysteries = [
            {
                title: "The Annunciation",
                scripture: "Luke 1:26-38\n\nIn the sixth month the angel Gabriel was sent from God to a city of Galilee named Nazareth, to a virgin betrothed to a man whose name was Joseph, of the house of David; and the virgin's name was Mary. And he came to her and said, “Hail, full of grace, the Lord is with you!” But she was greatly troubled at the saying, and considered in her mind what sort of greeting this might be. And the angel said to her, “Do not be afraid, Mary, for you have found favor with God. And behold, you will conceive in your womb and bear a son, and you shall call his name Jesus. He will be great, and will be called the Son of the Most High; and the Lord God will give to him the throne of his father David, and he will reign over the house of Jacob for ever; and of his kingdom there will be no end.” And Mary said to the angel, “How can this be, since I have no husband?” And the angel said to her, “The Holy Spirit will come upon you, and the power of the Most High will overshadow you; therefore the child to be born will be called holy, the Son of God. And behold, your kinswoman Elizabeth in her old age has also conceived a son; and this is the sixth month with her who was called barren. For with God nothing will be impossible.” And Mary said, “Behold, I am the handmaid of the Lord; let it be to me according to your word.” And the angel departed from her."},
            {
                title: "The Visitation",
                scripture: "Luke 1:39-56\n\nIn those days Mary arose and went with haste into the hill country, to a city of Judah, and she entered the house of Zechariah and greeted Elizabeth. And when Elizabeth heard the greeting of Mary, the babe leaped in her womb; and Elizabeth was filled with the Holy Spirit and she exclaimed with a loud cry, “Blessed are you among women, and blessed is the fruit of your womb! And why is this granted me, that the mother of my Lord should come to me? For behold, when the voice of your greeting came to my ears, the babe in my womb leaped for joy. And blessed is she who believed that there would be a fulfilment of what was spoken to her from the Lord.” And Mary said, “My soul magnifies the Lord, and my spirit rejoices in God my Savior, for he has regarded the low estate of his handmaiden. For behold, henceforth all generations will call me blessed; for he who is mighty has done great things for me, and holy is his name. And his mercy is on those who fear him"},
            {
                title: "The Nativity",
                scripture: "Luke 2:1-20\n\nIn those days a decree went out from Caesar Augustus that all the world should be enrolled. This was the first enrollment, when Quirin′ius was governor of Syria. And all went to be enrolled, each to his own city. And Joseph also went up from Galilee, from the city of Nazareth, to Judea, to the city of David, which is called Bethlehem, because he was of the house and lineage of David, to be enrolled with Mary, his betrothed, who was with child. And while they were there, the days were completed for her to be delivered. And she gave birth to her first-born son, and wrapped him in swaddling clothes, and laid him in a manger, because there was no place for them in the inn. And in that region there were shepherds out in the field, keeping watch over their flock by night. An angel of the Lord appeared to them, and the glory of the Lord shone around them, and they were greatly frightened. And the angel said to them, “Do not be afraid; for behold, I bring you good news of a great joy which will come to all the people; for to you is born this day in the city of David a Savior, who is Christ the Lord. And this will be a sign for you: you will find a babe wrapped in swaddling clothes and lying in a manger.” And suddenly there was with the angel a multitude of the heavenly host praising God and saying, “Glory to God in the highest, and on earth peace among men with whom he is pleased!” When the angels went away from them into heaven, the shepherds said to one another, “Let us go over to Bethlehem and see this thing that has happened, which the Lord has made known to us.” And they went with haste, and found Mary and Joseph, and the babe lying in a manger. And when they saw it, they made known the saying which had been told them concerning this child; and all who heard him wondered at what the shepherds told them. But Mary kept all these things, pondering them in her heart. And the shepherds returned, glorifying and praising God for all they had heard and seen, as it had been told them."},
            {
                title: "The Presentation",
                scripture: "Luke 2:22-38\n\nAnd when the time came for their purification according to the law of Moses, they brought him up to Jerusalem to present him to the Lord (as it is written in the law of the Lord, “Every male that opens the womb shall be called holy to the Lord”) and to offer a sacrifice according to what is said in the law of the Lord, “a pair of turtledoves, or two young pigeons.” Now there was a man in Jerusalem, whose name is Simeon, and this man was righteous and devout, looking for the consolation of Israel; and the Holy Spirit was upon him. And it had been revealed to him by the Holy Spirit that he should not see death before he had seen the Lord's Christ. And inspired by the Spirit he came into the temple; and when the parents brought in the child Jesus, to do for him according to the custom of the law, he took him up in his arms and blessed God and said, “Lord, now lettest thou thy servant depart in peace, according to thy word; for mine eyes have seen thy salvation which thou hast prepared in the presence of all peoples, a light for revelation to the Gentiles, and for glory to thy people Israel.” And there was a prophetess, Anna, the daughter of Phan′uel, of the tribe of Asher; she was of great age, having lived with her husband seven years from her virginity, and as a widow till she was eighty-four. She did not depart from the temple, worshiping with fasting and prayer night and day. And coming up at that very hour she gave thanks to God, and spoke of him to all who were looking for the redemption of Jerusalem."},
            {
                title: "The Finding in the Temple",
                scripture: "Luke 2:41-52\n\nNow his parents went to Jerusalem every year at the feast of the Passover. And when he was twelve years old, they went up according to custom; and when the feast was ended, as they were returning, the boy Jesus stayed behind in Jerusalem. His parents did not know it, but supposing him to be in the company they traveled a day's journey, and then sought him among their kinsfolk and acquaintances; and when they did not find him, they returned to Jerusalem, seeking him. After three days they found him in the temple, sitting among the teachers, listening to them and asking them questions; and all who heard him were amazed at his understanding and his answers. And when they saw him they were astonished; and his mother said to him, “Son, why have you treated us so? Behold, your father and I and I have been looking for you anxiously.” And he said to them, “How is it that you sought me? Did you not know that I must be in my Father's house?” And they did not understand the saying which he spoke to them. He went down with them and came to Nazareth, and was obedient to them; and his mother kept all these things in her heart. And Jesus increased in wisdom and in stature, and in favor with God and man."}
        ];

        // Rosary State
        let rosaryState = {
            currentMysteryIndex: 0,
            currentPrayerIndex: 0,
            prayers: [] // Will be populated per mystery
        };

        // Function to populate prayers for a mystery
        function getPrayersForMystery() {
            return [
                { type: 'Our Father', text: OUR_FATHER },
                ...Array(10).fill({ type: 'Hail Mary', text: HAIL_MARY }),
                { type: 'Glory Be', text: GLORY_BE },
                { type: 'Fatima Prayer', text: FATIMA_PRAYER }
            ];
        }

        // Custom Alert Function
        const customAlertModal = document.getElementById('custom-alert-modal');
        const alertMessageElement = document.getElementById('alert-message');
        const alertOkButton = document.getElementById('alert-ok-button');
        const alertOverlay = document.getElementById('alert-overlay');

        function showCustomAlert(message) {
            alertMessageElement.textContent = message;
            customAlertModal.classList.add('visible');
            alertOverlay.classList.add('active');
        }

        function hideCustomAlert() {
            customAlertModal.classList.add('fade-out');
            customAlertModal.addEventListener('animationend', () => {
                customAlertModal.classList.remove('visible', 'fade-out');
                alertOverlay.classList.remove('active');
            }, { once: true });
        }

        alertOkButton.addEventListener('click', hideCustomAlert);

        // Show Section Function
        function showSection(sectionId) {
            const sections = document.querySelectorAll('.main-content-container section');
            sections.forEach(section => section.classList.add('hidden'));
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.remove('hidden');
            } else {
                console.error("Section not found:", sectionId);
            }
        }

        // Authentication
        async function initializeAuth() {
            try {
                if (initialAuthToken) {
                    await auth.signInWithCustomToken(initialAuthToken);
                } else {
                    await auth.signInAnonymously();
                }
            } catch (error) {
                console.error('Auth error:', error);
                showCustomAlert('Authentication failed. Please try again.');
            }
        }

        // Load User Profile
        async function loadUserProfile() {
            try {
                const userDocRef = db.collection(`artifacts/${appId}/users`).doc(currentUser.uid);
                const doc = await userDocRef.get();
                if (doc.exists) {
                    userProfile = doc.data();
                    document.getElementById('chat-header').textContent = `Welcome, ${userProfile.username}! (Class: ${userProfile.classId})`;
                    document.getElementById('profile-setup').classList.add('hidden'); // Hide profile setup
                    document.getElementById('message-input').disabled = false; // Enable message input
                    document.getElementById('send-button').disabled = false; // Enable send button
                    // Re-enable pointer events for the message input area if it was disabled
                    document.getElementById('message-input-area').style.pointerEvents = 'auto';
                    setupChatListener(); // Start listening for messages after profile is loaded
                } else {
                    document.getElementById('profile-setup').classList.remove('hidden'); // Show profile setup
                    document.getElementById('message-input').disabled = true; // Disable message input
                    document.getElementById('send-button').disabled = true; // Disable send button
                    document.getElementById('message-input-area').style.pointerEvents = 'none'; // Disable pointer events for the area
                }
            } catch (error) {
                console.error('Profile load error:', error);
                showCustomAlert('Failed to load profile.');
            }
        }

        // Save Profile
        async function saveProfile() {
            const username = document.getElementById('username-input').value.trim();
            const classId = document.getElementById('class-input').value.trim();
            if (!username || !classId) {
                showCustomAlert('Please enter both username and class ID.');
                return;
            }
            try {
                const userDocRef = db.collection(`artifacts/${appId}/users`).doc(currentUser.uid);
                await userDocRef.set({
                    username,
                    classId,
                    completedLessons: [],
                    currentLessonIndex: 0
                });
                userProfile = { username, classId, completedLessons: [], currentLessonIndex: 0 };
                loadUserProfile(); // Reload profile to update UI and enable chat
            } catch (error) {
                console.error('Save profile error:', error);
                showCustomAlert('Failed to save profile.');
            }
        }

        // Chat Listener
        function setupChatListener() {
            if (!userProfile || !userProfile.classId) {
                console.warn("User profile or class ID not set. Cannot set up chat listener.");
                document.getElementById('messages-area').innerHTML = '<div class="loading-message">Please set your username and class to view chat messages.</div>';
                return;
            }

            // Using compat syntax for collection reference
            db.collection(`artifacts/${appId}/public/data/messages`)
                .orderBy('timestamp', 'asc')
                .onSnapshot(snapshot => {
                    const messagesArea = document.getElementById('messages-area');
                    messagesArea.innerHTML = ''; // Clear existing messages
                    if (snapshot.empty) {
                        messagesArea.innerHTML = '<div class="loading-message">No messages in this chat yet. Be the first to say hello!</div>';
                    }
                    snapshot.forEach(doc => {
                        const message = doc.data();
                        displayMessage(message);
                    });
                    messagesArea.scrollTop = messagesArea.scrollHeight; // Scroll to bottom
                }, error => {
                    console.error("Error listening to messages:", error);
                    messagesArea.innerHTML = `<div class="loading-message" style="color: red;">Error loading messages: ${error.message}</div>`;
                });
        }

        // Display Message
        function displayMessage(message) {
            const messagesArea = document.getElementById('messages-area');
            const messageElement = document.createElement('div');
            messageElement.classList.add('message-bubble');

            const isSentByCurrentUser = currentUser && message.senderId === currentUser.uid;
            if (isSentByCurrentUser) {
                messageElement.classList.add('sent');
            } else {
                messageElement.classList.add('received');
            }

            const senderDisplayName = message.username || 'Anonymous';
            const senderElement = document.createElement('div');
            senderElement.classList.add('message-sender');
            senderElement.textContent = senderDisplayName;
            messageElement.appendChild(senderElement);

            const textElement = document.createElement('div');
            textElement.textContent = message.text;
            messageElement.appendChild(textElement);

            messagesArea.appendChild(messageElement);
        }

        // Send Message
        async function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const messageText = messageInput.value.trim();

            if (messageText === '' || !currentUser || !userProfile || !userProfile.username || !userProfile.classId) {
                showCustomAlert("Please set your username and class before sending messages.");
                return;
            }

            try {
                await db.collection(`artifacts/${appId}/public/data/messages`).add({
                    text: messageText,
                    senderId: currentUser.uid,
                    username: userProfile.username,
                    classId: userProfile.classId,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                messageInput.value = '';
            } catch (error) {
                console.error("Error sending message:", error);
                showCustomAlert("Failed to send message. Please try again.");
            }
        }

        // Lessons Logic
        function loadCategories() {
            const container = document.getElementById('categories-container');
            container.innerHTML = '';
            const uniqueCategories = [...new Set(lessonsData.map(data => data.category))]; // Extract unique categories
            uniqueCategories.forEach(categoryName => {
                const btn = document.createElement('button');
                btn.classList.add('button-theme', 'category-button');
                btn.textContent = categoryName;
                btn.onclick = () => loadLessonsForCategory(categoryName); // Pass category name directly
                container.appendChild(btn);
            });
            document.getElementById('lessons-container').style.display = 'none';
            document.getElementById('categories-container').style.display = 'flex'; // Ensure categories are visible
            document.getElementById('back-to-categories-button').style.display = 'none';
        }

        function loadLessonsForCategory(categoryName) {
            const categoryData = lessonsData.find(data => data.category === categoryName);
            if (!categoryData) {
                console.error("Category not found:", categoryName);
                return;
            }

            const lessonsContainer = document.getElementById('lessons-container');
            lessonsContainer.innerHTML = '';
            categoryData.lessons.forEach(lesson => {
                const btn = document.createElement('button');
                btn.classList.add('button-theme', 'lesson-button');
                const isCompleted = userProfile && userProfile.completedLessons && userProfile.completedLessons.includes(lesson.id);
                btn.textContent = `${lesson.title} ${isCompleted ? ' (Completed)' : ''}`;
                btn.onclick = () => loadLessonContent(lesson);
                lessonsContainer.appendChild(btn);
            });
            document.getElementById('categories-container').style.display = 'none';
            lessonsContainer.style.display = 'flex'; // Display lessons as flex
            document.getElementById('back-to-categories-button').style.display = 'block';
        }

        function loadLessonContent(lesson) {
            currentLesson = lesson; // Set current lesson
            showSection('lesson-content-section');
            document.getElementById('current-lesson-title').textContent = lesson.title;
            document.getElementById('current-lesson-content').innerHTML = lesson.content;

            const videoContainer = document.getElementById('lesson-video-container');
            const videoFrame = document.getElementById('lesson-video');
            if (lesson.videoUrl) {
                videoFrame.src = lesson.videoUrl;
                videoContainer.style.display = 'block';
            } else {
                videoFrame.src = '';
                videoContainer.style.display = 'none';
            }

            const takeQuizBtn = document.getElementById('take-quiz-button');
            const isCompleted = userProfile && userProfile.completedLessons && userProfile.completedLessons.includes(lesson.id);
            takeQuizBtn.disabled = isCompleted;
            takeQuizBtn.textContent = isCompleted ? 'Quiz Completed' : 'Take Quiz';
        }

        function startQuiz() {
            if (!currentLesson || !currentLesson.quiz) {
                showCustomAlert("No quiz available for this lesson.");
                return;
            }
            currentQuiz = currentLesson.quiz;
            showSection('quiz-section');
            document.getElementById('quiz-title').textContent = `Quiz: ${currentLesson.title}`;
            const quizQuestionsContainer = document.getElementById('quiz-questions-container');
            quizQuestionsContainer.innerHTML = '';

            const questionDiv = document.createElement('div');
            questionDiv.classList.add('quiz-question');
            questionDiv.innerHTML = `<p>${currentQuiz.question}</p>`;

            currentQuiz.options.forEach((option, index) => {
                const label = document.createElement('label');
                label.classList.add('quiz-option');
                const input = document.createElement('input');
                input.type = 'radio';
                input.name = 'quiz-answer';
                input.value = index;
                label.appendChild(input);
                label.appendChild(document.createTextNode(option));
                questionDiv.appendChild(label);
            });
            quizQuestionsContainer.appendChild(questionDiv);
            document.getElementById('submit-quiz-button').disabled = false;
        }

        async function submitQuiz() {
            const selectedOption = document.querySelector('input[name="quiz-answer"]:checked');
            if (!selectedOption) {
                showCustomAlert("Please select an answer.");
                return;
            }

            const userAnswer = parseInt(selectedOption.value);
            if (userAnswer === currentQuiz.correct) {
                showCustomAlert("Correct! You've passed this lesson.");
                document.getElementById('submit-quiz-button').disabled = true;

                if (userProfile && userProfile.completedLessons && !userProfile.completedLessons.includes(currentLesson.id)) {
                    userProfile.completedLessons.push(currentLesson.id);
                    await db.collection(`artifacts/${appId}/users`).doc(currentUser.uid).update({
                        completedLessons: userProfile.completedLessons
                    });
                }
                loadLessonsForCategory(currentLesson.category); // Refresh lessons list
                showSection('lessons-list-section');
            } else {
                showCustomAlert("Incorrect. Please try again.");
            }
        }

        // Rosary Logic
        function initializeRosary() {
            rosaryState.currentMysteryIndex = 0;
            rosaryState.currentPrayerIndex = 0;
            rosaryState.prayers = getPrayersForMystery(); // Populate prayers for the first mystery
            displayCurrentRosaryPrayer();
            document.getElementById('rosary-next-button').style.display = 'block';
            document.getElementById('rosary-reset-button').style.display = 'block';
        }

        function displayCurrentRosaryPrayer() {
            if (rosaryState.currentMysteryIndex >= joyfulMysteries.length) {
                document.getElementById('current-mystery-title').textContent = "Rosary Completed!";
                document.getElementById('current-scripture').textContent = "";
                document.getElementById('current-prayer-text').textContent = "Praise be to God! You have completed the Rosary.";
                document.getElementById('rosary-next-button').style.display = 'none';
                showCustomAlert("Congratulations! You have completed the Holy Rosary.");
                return;
            }

            const mystery = joyfulMysteries[rosaryState.currentMysteryIndex];
            document.getElementById('current-mystery-title').textContent = `${rosaryState.currentMysteryIndex + 1}. ${mystery.title}`;
            document.getElementById('current-scripture').textContent = mystery.scripture;

            if (rosaryState.currentPrayerIndex < rosaryState.prayers.length) {
                const prayer = rosaryState.prayers[rosaryState.currentPrayerIndex];
                document.getElementById('current-prayer-text').textContent = `${prayer.type}: ${prayer.text}`;
            } else {
                // Move to the next mystery
                rosaryState.currentMysteryIndex++;
                rosaryState.currentPrayerIndex = 0; // Reset prayer index for the new mystery
                rosaryState.prayers = getPrayersForMystery(); // Re-populate prayers for the new mystery
                displayCurrentRosaryPrayer(); // Recurse to display the first prayer of the new mystery
            }
        }

        function nextRosaryPrayer() {
            rosaryState.currentPrayerIndex++;
            displayCurrentRosaryPrayer();
        }

        function resetRosary() {
            initializeRosary();
            showCustomAlert("Rosary has been reset.");
        }


        // Event Listeners Initialization
        function initNavListeners() {
            document.getElementById('home-nav-button').addEventListener('click', () => {
                showSection('main-menu-section');
            });
            document.getElementById('lessons-nav-button').addEventListener('click', () => {
                showSection('lessons-list-section');
                loadCategories(); // Load categories when lessons button is clicked
            });
            document.getElementById('spiritual-nav-button').addEventListener('click', () => {
                showSection('spiritual-formation-section');
            });
            document.getElementById('chat-menu-button').addEventListener('click', () => {
                showSection('chat-section');
            });
            document.getElementById('resources-nav-button').addEventListener('click', () => {
                showSection('student-resources-section');
            });
            document.getElementById('quit-nav-button').addEventListener('click', () => {
                showCustomAlert("Thank you for using Catechumen! You can close this window.");
            });

            // Lessons & Quiz Buttons
            document.getElementById('take-quiz-button').addEventListener('click', startQuiz);
            document.getElementById('back-to-lessons-list-button').addEventListener('click', () => {
                loadLessonsForCategory(currentLesson.category); // Go back to the specific category list
                showSection('lessons-list-section');
            });
            document.getElementById('submit-quiz-button').addEventListener('click', submitQuiz);
            document.getElementById('back-to-lesson-from-quiz-button').addEventListener('click', () => {
                loadLessonContent(currentLesson); // Go back to the current lesson content
            });
            document.getElementById('back-to-categories-button').addEventListener('click', loadCategories);


            // Spiritual Formation Buttons
            document.getElementById('lectio-divina-button').addEventListener('click', () => {
                showCustomAlert("Lectio Divina functionality coming soon!");
            });
            document.getElementById('guided-rosary-button').addEventListener('click', () => {
                showSection('rosary-section');
                initializeRosary();
            });
            document.getElementById('common-prayers-button').addEventListener('click', () => {
                showCustomAlert("Common Prayers functionality coming soon!");
            });
            document.getElementById('liturgy-hours-button').addEventListener('click', () => {
                showCustomAlert("Liturgy of the Hours functionality coming soon!");
            });
            document.getElementById('spiritual-back-to-main-button').addEventListener('click', () => {
                showSection('main-menu-section');
            });

            // Rosary Buttons
            document.getElementById('rosary-next-button').addEventListener('click', nextRosaryPrayer);
            document.getElementById('rosary-reset-button').addEventListener('click', resetRosary);
            document.getElementById('rosary-back-to-spiritual-button').addEventListener('click', () => {
                showSection('spiritual-formation-section');
            });

            // Chat Buttons/Inputs
            document.getElementById('save-profile-button').addEventListener('click', saveProfile);
            document.getElementById('message-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            document.getElementById('send-button').addEventListener('click', sendMessage);
            document.getElementById('close-chat-button').addEventListener('click', () => {
                showSection('main-menu-section');
            });
        }

        // Initialize on DOMContentLoaded
        window.addEventListener('DOMContentLoaded', () => {
            // Main content container is now immediately visible
            document.querySelector('.main-content-container').style.display = 'flex';
            document.querySelector('.main-content-container').style.opacity = '1';

            initializeAuth(); // Start Firebase auth process
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    loadUserProfile(); // Load user profile once authenticated
                } else {
                    currentUser = null;
                    userProfile = null;
                    // Handle unauthenticated state, e.g., show profile setup if chat is entered
                    document.getElementById('profile-setup').classList.remove('hidden');
                    document.getElementById('message-input').disabled = true;
                    document.getElementById('send-button').disabled = true;
                    document.getElementById('messages-area').innerHTML = '<div class="loading-message">Please sign in to use chat.</div>';
                }
            });
            initNavListeners(); // Initialize all event listeners
            showSection('main-menu-section'); // Show initial section immediately
        });
    </script>
</body>
</html>
